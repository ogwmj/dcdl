<!DOCTYPE html>
<html lang="en" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DC: Dark Legion - Optimal Team Builder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <link rel="stylesheet" href="https://cdn.datatables.net/2.3.1/css/dataTables.dataTables.min.css">
    <script src="https://cdn.datatables.net/2.3.1/js/dataTables.min.js"></script>

    <style>
        /* Custom font for Inter */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');

        /* CSS Variables for Theming (Single Theme - Light) */
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f0f4f8;
            --bg-section: #ffffff;
            --bg-section-alt: #f8fafc; 
            --bg-input: #ffffff;
            --text-primary: #1e293b;   /* Slate 800 */
            --text-secondary: #334155; /* Slate 700 */
            --text-muted: #64748b;     /* Slate 500 */
            --text-button: #ffffff;
            --border-primary: #e2e8f0; /* Slate 200 */
            --border-input: #cbd5e1;   /* Slate 300 */
            --border-focus: #3b82f6;   /* Blue 500 */
            --border-focus-shadow: rgba(59, 130, 246, 0.2);
            --shadow-color: rgba(0, 0, 0, 0.1);
            --shadow-section-color: rgba(0, 0, 0, 0.08);
            --btn-primary-bg: #3b82f6;
            --btn-primary-hover-bg: #2563eb;
            --btn-primary-disabled-bg: #93c5fd;
            --btn-secondary-bg: #64748b;
            --btn-secondary-hover-bg: #475569;
            --btn-success-bg: #10b981;
            --btn-success-hover-bg: #059669;
            --btn-danger-bg: #ef4444;
            --btn-danger-hover-bg: #dc2626;
            --btn-warning-bg: #ffc107;
            --btn-warning-hover-bg: #ffc107; 
            --btn-info-bg: #0dcaf0;
            --btn-info-hover-bg: #0dcaf0;
            --result-box-bg: #e0f2fe;
            --result-box-border: #3b82f6;
            --result-box-text-strong: #1e40af;
            --probability-box-bg: #f0fdfa;
            --probability-box-border: #06b6d4;
            --probability-box-text-strong: #0e7490;
            --advisory-box-bg: #fffbeb;
            --advisory-box-border: #f59e0b;
            --advisory-box-text: #78350f;
            --toggle-on-bg: #10b981;
            --toggle-on-border: #059669;
            --toggle-off-bg: #d1d5db;
            --toggle-off-border: #9ca3af;
            --toggle-off-text: #4b5563;
            --chart-bg: #ffffff;
            --chart-grid-color: rgba(0, 0, 0, 0.1);
            --chart-font-color: #6b7280; 
            --chart-title-color: #1e293b; 
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-secondary);
            color: var(--text-primary);
        }
        .container {
            max-width: 90%; 
            margin: 2rem auto;
            padding: 1.5rem;
            background-color: var(--bg-primary);
            border-radius: 1rem; 
            box-shadow: 0 10px 20px var(--shadow-color);
        }
        .input-group label {
            font-weight: 600;
            color: var(--text-secondary);
        }
        .input-group input, .input-group select, .input-group textarea {
            border: 1px solid var(--border-input);
            background-color: var(--bg-input);
            color: var(--text-primary);
            border-radius: 0.5rem; 
            padding: 0.6rem 0.8rem;
            margin-top: 0.3rem;
            width: 100%;
            transition: border-color 0.2s;
        }
        .input-group input::placeholder, .input-group textarea::placeholder {
            color: var(--text-muted); 
        }
        .input-group input:focus, .input-group select:focus, .input-group textarea:focus {
             border-color: var(--border-focus);
             box-shadow: 0 0 0 2px var(--border-focus-shadow); 
        }
        
        .btn { 
            padding: 0.8rem 1.5rem;
            border-radius: 0.75rem; 
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s, box-shadow 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem; /* Default gap for icon and text */
            color: var(--text-button);
        }
        .btn-sm { /* Smaller padding for smaller buttons */
            padding: 0.4rem 0.8rem;
            font-size: 0.875rem; /* text-sm */
        }

        .btn-primary {
            background-color: var(--btn-primary-bg);
            box-shadow: 0 4px 6px var(--shadow-color);
        }
        .btn-primary:hover:not(:disabled) {
            background-color: var(--btn-primary-hover-bg);
            transform: translateY(-1px);
        }
        .btn-primary:disabled {
            background-color: var(--btn-primary-disabled-bg);
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }
        .btn-info {
            background-color: var(--btn-info-bg);
            box-shadow: 0 4px 6px var(--shadow-color);
        }
        .btn-info:hover:not(:disabled) {
            background-color: var(--btn-info-hover-bg); 
            transform: translateY(-1px);
        }
        .btn-info:disabled {
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }
        .btn-warning {
            background-color: var(--btn-warning-bg);
            box-shadow: 0 4px 6px var(--shadow-color);
        }
        .btn-warning:hover:not(:disabled) {
            background-color: var(--btn-warning-hover-bg); 
            transform: translateY(-1px);
        }
        .btn-warning:disabled {
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }
        .btn-secondary {
            background-color: var(--btn-secondary-bg);
            box-shadow: 0 4px 6px var(--shadow-color);
        }
        .btn-secondary:hover:not(:disabled) {
            background-color: var(--btn-secondary-hover-bg);
            transform: translateY(-1px);
        }
         .btn-success { 
            background-color: var(--btn-success-bg);
            box-shadow: 0 4px 6px var(--shadow-color);
        }
        .btn-success:hover:not(:disabled) {
            background-color: var(--btn-success-hover-bg);
            transform: translateY(-1px);
        }
        .btn-danger {
            background-color: var(--btn-danger-bg);
            box-shadow: 0 4px 6px var(--shadow-color);
        }
        .btn-danger:hover:not(:disabled) {
            background-color: var(--btn-danger-hover-bg);
            transform: translateY(-1px);
        }
        .result-box {
            background-color: var(--result-box-bg);
            border-left: 4px solid var(--result-box-border);
            padding: 1rem;
            border-radius: 0.75rem;
            margin-top: 1rem;
        }
        .result-box strong {
            color: var(--result-box-text-strong);
        }
        #unlockCostSection .result-box { 
            background-color: #eef2ff; 
            border-left-color: #6366f1; 
        }
         #unlockCostSection .result-box strong {
            color: #3730a3; 
        }

        .status-success {
            color: #047857; 
            background-color: #d1fae5; 
        }
        .status-error {
            color: #b91c1c; 
            background-color: #fee2e2; 
        }
        .status-info { 
            color: #0369a1; 
            background-color: #e0f2fe; 
        }
        .status-message {
            font-size: 0.875rem;
            margin-top: 0.5rem;
            padding: 0.5rem;
            border-radius: 0.5rem;
            min-height: 2rem; 
        }
      
        h1 { color: var(--text-primary); }
        h2 { color: var(--text-secondary); border-bottom: 1px solid var(--border-primary); padding-bottom: 0.5rem; margin-bottom: 1rem; }
        h3, h4 { color: var(--text-secondary); }
        #currentSystemTitle, #proposedSystemTitle { color: var(--result-box-border); }
        #unlockCostSection h3 { color: var(--result-box-border); } 
        .calculation-detail h3, .calculation-detail h4 { color: var(--text-primary); }
        .calculation-detail p { color: var(--text-muted); }
        .calculation-detail strong { color: var(--text-primary); }

        details {
            background-color: var(--bg-section-alt);
            border: 1px solid var(--border-primary);
            border-radius: 0.75rem;
            padding: 1rem;
            margin-top: 1.5rem;
            box-shadow: inset 0 1px 3px var(--shadow-section-color);
        }
        details summary {
            color: var(--text-secondary);
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        details summary::-webkit-details-marker { display: none; }
        details summary::after { content: '+'; font-size: 1.5rem; transition: transform 0.2s; }
        details[open] summary::after { content: '-'; }
        
        #customizeViewDetails {
            background-color: var(--bg-section-alt); 
            border-color: var(--border-primary);
        }
        #customizeViewDetails summary {
            color: var(--btn-primary-bg); 
        }
        #sectionToggleContainer {
            background-color: var(--bg-primary); 
        }
        .toggle-item {
            border-bottom: 1px solid var(--border-primary);
            display: flex;
            align-items: center;
            justify-content: space-between; 
            padding: 0.3rem 0;
        }
        .toggle-item:last-child { border-bottom: none; }
        .toggle-label {
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            flex-grow: 1;
        }
        .toggle-label input[type="checkbox"] {
            accent-color: var(--btn-primary-bg);
            margin-right: 0.5rem;
        }
        .order-buttons button {
            background-color: var(--bg-input); 
            color: var(--text-muted); 
            border: 1px solid var(--border-input); 
            padding: 0.25rem 0.5rem; 
            font-size: 0.8rem;
            line-height: 1;
            margin-left: 0.25rem;
        }
        .order-buttons button:hover:not(:disabled) {
            background-color: var(--bg-secondary); 
        }
        .order-buttons button:disabled {
            background-color: var(--bg-section-alt); 
            color: var(--text-muted); 
            opacity: 0.6;
            cursor: not-allowed;
        }

        .advisory-box { 
            background-color: var(--advisory-box-bg);
            border-left: 4px solid var(--advisory-box-border);
            color: var(--advisory-box-text);
            padding: 1rem;
            border-radius: 0.75rem;
            margin-top: 1.5rem;
            font-size: 0.95rem;
        }
        .advisory-box.advisory-indigo-theme { 
            background-color: #eef2ff; 
            border-left-color: #6366f1; 
            color: #3730a3; 
        }
       
        .chart-container { 
            background-color: var(--chart-bg);
            position: relative;
            width: 100%;
            margin-top: 1rem; 
            padding: 1rem;
            border-radius: 1rem;
            box-shadow: 0 5px 15px var(--shadow-section-color);
        }
        .main-chart-container { height: 400px; margin-top: 2rem; }
        .prob-chart-container { height: 300px; }
        .main-chart-container h3, .prob-chart-container h4 { color: var(--text-primary); }
        .prob-chart-container h4 { color: var(--btn-primary-bg); }
        #probSummaryCurrent, #probSummaryProposed, #probabilitySimulationDetails { color: var(--text-muted); }
        
        .calc-section { 
            padding: 1.5rem; border-radius: 0.75rem; 
            box-shadow: 0 4px 12px var(--shadow-section-color); 
            margin-bottom: 2rem; border: 1px solid var(--border-primary); 
            background-color: var(--bg-section); 
        }
        .calc-section.alt-bg { background-color: var(--bg-section-alt); } 
        .btn-loading .btn-text { display: none; }
        .btn-loading .spinner { display: inline-block; width: 1.25rem; height: 1.25rem; border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: var(--text-button); animation: spin 1s ease-in-out infinite; }
        .spinner { display: none; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .toggle-btn {
            cursor: pointer;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.3s ease, color 0.3s ease;
            width: 100%; 
            text-align: center;
        }
        .toggle-btn-on { 
            background-color: var(--toggle-on-bg);
            color: var(--text-button); 
            border: 1px solid var(--toggle-on-border);
        }
        .toggle-btn-off { 
            background-color: var(--toggle-off-bg);
            color: var(--toggle-off-text);
            border: 1px solid var(--toggle-off-border);
        }

        /* Explanation Section Styles */
        .help-section { 
            background-color: var(--bg-section-alt);
            border: 1px solid var(--border-primary);
        }
        .help-section summary {
            color: var(--text-secondary);
            font-size: 1.125rem; /* text-lg */
        }
        .help-section div p {
            margin-bottom: 0.75rem; /* mb-3 */
            line-height: 1.6;
            color: var(--text-muted);
        }
        .help-section div h3 { /* Main topics in help */
            font-size: 1.25rem; /* text-xl */
            font-weight: 700; /* font-bold */
            color: var(--text-primary);
            margin-top: 1.5rem; /* mt-6 */
            margin-bottom: 0.75rem; /* mb-3 */
            padding-bottom: 0.5rem; /* pb-2 */
            border-bottom: 1px solid var(--border-primary);
        }
         .help-section div h3:first-child {
            margin-top: 0.5rem; 
        }
        .help-section div h4 { /* Sub-topics in help */
            font-size: 1.125rem; 
            font-weight: 600; 
            color: var(--text-secondary);
            margin-top: 1.25rem; 
            margin-bottom: 0.5rem; 
        }
        .help-section ul {
            list-style-type: disc;
            margin-left: 1.5rem; 
            color: var(--text-muted);
            padding-left: 0.5rem; 
        }
        .help-section ul ul { 
            margin-top: 0.5rem; 
            margin-bottom: 0.5rem; 
        }
        .help-section li {
            margin-bottom: 0.5rem; 
        }
        .help-section strong { 
            font-weight: 600;
            color: var(--text-primary);
        }
        .help-section code {
            background-color: var(--border-primary); 
            color: var(--btn-danger-bg); 
            padding: 0.125rem 0.375rem; 
            border-radius: 0.25rem; 
            font-size: 0.875em;
        }


        /* Responsive adjustments */
        @media (min-width: 640px) { .container { max-width: 600px; } }
        @media (min-width: 1024px) { .container { max-width: 768px; } }
        @media (min-width: 1280px) { .container { max-width: 1024px; } }

        /* Modal Styles */
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-backdrop.active {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: #ffffff; 
            color: #1e293b; 
            padding: 1.5rem; 
            border-radius: 0.5rem; 
            box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04); 
            max-width: 90vw; 
            width: 500px; 
        }
        .modal-content h3 {
            font-size: 1.25rem; 
            font-weight: 600; 
            color: #1e293b; 
            margin-bottom: 1rem;
        }
        .modal-content input[type="text"], .modal-content textarea { /* Apply to input in modal */
            width: 100%;
            border: 1px solid #cbd5e1; /* var(--border-input); */
            background-color: #ffffff; /* var(--bg-input); */
            color: #1e293b; /* var(--text-primary); */
            padding: 0.5rem;
            border-radius: 0.375rem; /* rounded-md */
            margin-bottom: 1rem;
            font-family: inherit; /* Use body font */
            font-size: 1rem; /* Standard input font size */
        }
        .modal-content textarea {
             min-height: 100px; 
             font-family: monospace;
             font-size: 0.875rem;
        }
        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem; 
        }
        
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1); 
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #4f46e5; 
            animation: spin 1s ease infinite;
            margin: 20px auto;
        }
        .saving-indicator {
            display: inline-block;
            border: 2px solid rgba(0,0,0,0.1);
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border-left-color: #4f46e5; 
            animation: spin 0.8s ease infinite;
            margin-left: 8px;
        }
        
        h1 { color: var(--text-primary); @apply text-3xl md:text-4xl font-bold; }
        h2 { color: var(--text-primary); border-bottom: 1px solid var(--border-primary); @apply text-xl md:text-2xl font-semibold pb-2 mb-4; }
        h3 { color: var(--text-secondary); @apply text-lg font-medium mb-2; }
        h4 { color: var(--text-secondary); @apply text-md font-semibold mb-2; }
        #results-output p, #saved-teams-list p { color: var(--text-muted); }
        #error-indicator p { color: var(--btn-danger-bg); }
        #loading-indicator p { color: var(--btn-primary-bg);}

        /* Scrollbar styling for light theme */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Styles for text placeholders in table */
        .icon-placeholder {
            @apply inline-block align-middle text-xs font-semibold mr-1 px-1 py-0.5 rounded bg-gray-200 text-gray-700 border border-gray-300;
        }
        img.icon-class-table { /* For roster table images - target img directly */
            max-width: 28px; 
            max-height: 28px; 
            vertical-align: middle;
            margin-right: 4px;
        }
        .result-icon { /* For results display cards */
             width: 24px; /* Default size for icons in results */
             height: 24px;
             object-fit: contain;
             margin-right: 2px; /* Add a little space between synergy icons */
        }
        .result-icon.class-icon { /* Specific size for class icon in results */
            width: 32px;
            height: 32px;
        }
        .champion-card .icon-placeholder { /* Fallback for results cards */
            @apply inline-block align-middle text-xs font-semibold px-1 py-0.5 rounded bg-gray-200 text-gray-700 border border-gray-300;
        }
        .star-rating {
            display: inline-block; 
            line-height: 1; 
        }
        .star-rating span {
            font-size: 1.2em; 
            margin-right: 1px; 
        }
        .synergy-item {
            text-align: center;
            @apply flex items-center justify-between p-2 mb-2 border rounded-lg shadow-sm bg-slate-50 hover:bg-slate-100 cursor-pointer transition-colors; 
        }
        .synergy-item img {
            margin: auto;
            @apply w-6 h-6 object-contain; 
        }
        .synergy-name {
            @apply font-semibold text-slate-700 flex-grow text-sm; 
        }
        .synergy-progress {
            @apply text-xs text-slate-500 ml-2 px-2 py-0.5 bg-slate-200 rounded-full; 
        }
        /* Toast Notification Styles */
        #toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            width: 300px;
        }
        .toast { 
            opacity: 0;
            transition: opacity 0.5s, transform 0.5s;
            transform: translateX(100%);
        }
        .toast.show { 
            opacity: 1;
            transform: translateX(0);
        }
        /* Score Breakdown Chart Styles */
        .score-chart-container {
            @apply w-full bg-gray-200 rounded-full h-6 mb-4 flex overflow-hidden border border-gray-300;
        }
        .score-chart-segment {
            @apply h-full flex items-center justify-center text-xs font-medium text-white text-center p-1 leading-none;
            transition: width 0.5s ease-in-out;
        }
        .score-chart-segment-label {
            @apply text-xs text-gray-700 mt-1;
        }
        .icon-wrapper { /* Added for robust onerror */
             display: inline-flex; /* Or inline-block if preferred */
             align-items: center;
        }
        .btn-icon { 
            margin-right: 0.35rem; /* Space between icon and text */
            font-size: 1em; /* Adjust size of unicode icon if needed */
            line-height: 1; /* Ensure proper vertical alignment */
        }
        /* Processing Modal Styles */
        #processing-modal .modal-content {
            width: 400px; /* Adjust width as needed */
        }
        .progress-bar-container {
            @apply w-full bg-gray-200 rounded-full h-4 mb-2 border border-gray-300 overflow-hidden;
        }
        #progress-bar-inner {
            @apply bg-blue-500 h-full rounded-full;
            width: 0%; /* Initial width */
            transition: width 0.3s ease-in-out;
        }
        #processing-status-text {
            @apply text-sm text-gray-600 mb-3 text-center;
        }
        /* Swap Champion Modal List Item Styles */
        #swap-modal-body li {
            @apply flex justify-between items-center;
        }
        #swap-modal-body .champion-details {
            @apply flex-grow; /* Allow name and class to take space */
        }
        #swap-modal-body .champion-synergies {
            @apply flex gap-1 ml-2; /* Synergies to the right */
        }
        #swap-modal-body .champion-synergies img {
            @apply w-4 h-4; /* Smaller synergy icons in modal list */
        }
        #swap-modal-body .star-rating {
            @apply ml-2; /* Space before star rating */
        }


    </style>
</head>
<body class="p-4 md:p-8">
    <script data-name="BMC-Widget" data-cfasync="false" src="https://cdnjs.buymeacoffee.com/1.0.0/widget.prod.min.js" data-id="ogwmj" data-description="Support me on Buy me a coffee!" data-message="No pressure." data-color="#5F7FFF" data-position="Right" data-x_margin="18" data-y_margin="18"></script>
    <div class="container">
        <h1 class="text-3xl font-bold text-center mb-2">DC: Dark Legion - Optimal Team Builder</h1>
        <p id="userIdDisplay" class="text-xs text-center text-gray-500 mb-1">User ID: Initializing...</p>
        <p class="text-center text-gray-600 mb-6">Select your champions and their progression to find your highest scoring team! Your roster is saved automatically.</p>

        <div id="loading-indicator" class="text-center card hidden">
            <div class="loading-spinner"></div>
            <p class="text-indigo-600">Loading game data & your roster...</p>
        </div>
        <div id="error-indicator" class="text-center card hidden p-4 bg-red-100 border border-red-300 text-red-700">
            <p>Error loading data. Please ensure Firestore is set up and populated.</p>
            <p id="error-message-details" class="text-xs mt-1"></p>
        </div>

        <section id="champions-section" class="card">
            <div class="calc-section bg-gray-50">
                <h2 id="form-mode-title" class="text-xl font-semibold mb-4">Add Your Champions to Roster</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                        <div class="input-group">
                            <label for="champ-select-db" class="input-label block text-sm">Select Base Champion:</label>
                            <select id="champ-select-db" class="input-field">
                                <option value="">-- Select Champion --</option>
                                </select>
                        </div>
                        <div class="input-group mt-4">
                            <label for="champ-base-rarity-display" class="input-label block text-sm">Base Rarity (auto):</label>
                            <input type="text" id="champ-base-rarity-display" class="display-field" readonly>
                        </div>
                        <div class="input-group mt-4">
                            <label for="champ-class-display" class="input-label block text-sm">Class (auto):</label>
                            <input type="text" id="champ-class-display" class="display-field" readonly>
                        </div>
                        <div class="input-group mt-4">
                            <label for="champ-healer-status-display" class="input-label block text-sm">Healer Status (auto):</label>
                            <input type="text" id="champ-healer-status-display" class="display-field" readonly>
                        </div>
                        <div class="input-group mt-4">
                            <label for="champ-star-color" class="input-label block text-sm">Your Star & Color Tier:</label>
                            <select id="champ-star-color" class="input-field">
                                </select>
                        </div>
                        <div class="input-group mt-4">
                            <label class="input-label">Inherent Synergies (auto):</label>
                            <div id="champ-inherent-synergies-display" class="p-2 border border-gray-300 rounded-md bg-gray-100 min-h-[40px] text-sm text-gray-600">
                                Select a base champion to see synergies.
                            </div>
                        </div>
                    </div>

                    <div>
                        <div class="input-group">
                            <label for="gear-head" class="input-label block text-sm"">Head Gear Rarity Equipped:</label>
                            <select id="gear-head" class="input-field gear-rarity-select"> </select>
                        </div>
                        <div class="input-group mt-4">
                            <label for="gear-arms" class="input-label block text-sm"">Arms Gear Rarity Equipped:</label>
                            <select id="gear-arms" class="input-field gear-rarity-select"> </select>
                        </div>
                        <div class="input-group mt-4">
                            <label for="gear-legs" class="input-label block text-sm"">Legs Gear Rarity Equipped:</label>
                            <select id="gear-legs" class="input-field gear-rarity-select"> </select>
                        </div>
                        <div class="input-group mt-4">
                            <label for="gear-chest" class="input-label block text-sm"">Chest Gear Rarity Equipped:</label>
                            <select id="gear-chest" class="input-field gear-rarity-select"> </select>
                        </div>
                        <div class="input-group mt-4">
                            <label for="gear-waist" class="input-label block text-sm"">Waist Gear Rarity Equipped:</label>
                            <select id="gear-waist" class="input-field gear-rarity-select"> </select>
                        </div>
                    </div>
                    
                    <div>
                        <div class="input-group">
                            <label for="legacy-piece-select" class="input-label block text-sm"">Select Legacy Piece (from DB):</label>
                            <select id="legacy-piece-select" class="input-field"> 
                                <option value="">-- None --</option>
                                </select>
                        </div>
                        <div class="mt-8 space-y-2">
                            <button id="add-update-champion-btn" class="btn btn-primary w-full">
                                <span class="btn-text">Add Champion to Roster</span> 
                                <span id="save-roster-indicator" class="saving-indicator hidden"></span>
                            </button>
                            <button id="cancel-edit-btn" class="btn btn-warning w-full hidden">
                                <span class="btn-text">Cancel Edit</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="calc-section bg-gray-50">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold">Your Champion Roster</h2>
                    <div class="flex items-center">
                        <input type="checkbox" id="toggle-score-column" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500" checked>
                        <label for="toggle-score-column" class="ml-2 text-sm text-gray-700">Show Ind. Score</label>
                    </div>
                </div>
                <div id="champions-roster-container" class="overflow-x-auto">
                    <div id="champions-roster-table-wrapper" class="mt-4">
                        <table id="rosterTable" class="display" style="width:100%">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Rarity</th>
                                    <th>Class</th>
                                    <th class="dt-column-score">Ind. Score</th> 
                                    <th>Star/Color</th>
                                    <th>Legacy Piece</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <section id="results-section" class="card">
            <div class="calc-section bg-gray-50">
                <h2 class="text-xl font-semibold mb-4">Find Optimal Team</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div class="flex items-center">
                        <input id="require-healer-checkbox" type="checkbox" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                        <label for="require-healer-checkbox" class="ml-2 block text-sm text-gray-700">Require Healer in Team?</label>
                    </div>
                    <div>
                        <div class="flex items-center mb-1">
                            <input id="exclude-saved-team-checkbox" type="checkbox" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                            <label for="exclude-saved-team-checkbox" class="ml-2 block text-sm text-gray-700">Exclude Champions from a Saved Team?</label>
                        </div>
                        <div class="input-group">
                            <select id="select-exclusion-team-dropdown" class="input-field" disabled>
                                <option value="">-- Select Saved Team to Exclude --</option>
                                <option value="ALL_SAVED_TEAMS">-- All Saved Teams --</option> 
                                </select>
                        </div>
                    </div>
                </div>
                <button id="calculate-btn" class="btn btn-secondary text-lg"> <span class="btn-text">Calculate Best Team</span>
                </button>
                <div id="results-output" class="mt-6 p-4 border border-dashed border-gray-300 rounded-md min-h-[100px] bg-gray-50">
                    <p class="text-gray-500">Results will be displayed here...</p>
                </div>
            </div>
        </section>

        <section id="saved-teams-section" class="card">
            <div class="calc-section bg-gray-50">
                <h2 class="text-xl font-semibold mb-4">Saved Teams</h2>
                <div id="saved-teams-list" class="space-y-4"> 
                    <p class="text-sm text-gray-500">No teams saved yet.</p>
                </div>
            </div>
        </section>

        <section id="synergies-section" class="card hidden">
            <div class="calc-section bg-gray-50">
                <h2 class="text-xl font-semibold mb-4">Available Synergies</h2>
                <div id="synergies-list" class="mt-2 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-x-3 gap-y-2">
                    <p class="text-sm text-gray-500 col-span-full">Loading synergies...</p> 
                </div>
            </div>
        </section>
        
    </div>

    <div id="synergy-champions-modal" class="modal-backdrop hidden">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 id="synergy-modal-title" class="text-xl font-semibold">Synergy Champions</h3>
                <button id="close-synergy-modal-btn" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <div id="synergy-modal-body" class="text-sm">
                </div>
        </div>
    </div>

    <div id="team-name-modal" class="modal-backdrop hidden">
        <div class="modal-content">
            <h3 id="team-name-modal-title" class="text-xl font-semibold mb-4">Enter Team Name</h3>
            <div class="input-group mb-4">
                <label for="team-name-input" class="input-label block text-sm mb-1">Team Name:</label>
                <input type="text" id="team-name-input" class="input-field">
            </div>
            <div class="modal-buttons">
                <button id="cancel-team-name-btn" class="btn btn-secondary">
                    <span class="btn-text">Cancel</span>
                </button>
                <button id="save-team-name-btn" class="btn btn-primary">
                    <span class="btn-text">Save Name</span>
                </button>
            </div>
        </div>
    </div>

    <div id="processing-modal" class="modal-backdrop hidden">
        <div class="modal-content">
            <h3 class="text-xl font-semibold mb-4 text-center">Calculating Optimal Team...</h3>
            <div id="processing-status-text" class="text-sm text-gray-600 mb-3 text-center">Initializing...</div>
            <div class="progress-bar-container">
                <div id="progress-bar-inner"></div>
            </div>
        </div>
    </div>

    <div id="toast-container"></div>


<script type="module">
    // Firebase SDK imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, getDocs, doc, setDoc, getDoc, deleteDoc, query, where, onSnapshot, orderBy, addDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"; 

    // --- Unicode Icon Definitions ---
    const ICON_ADD = 'âž•';
    const ICON_UPDATE = 'ï¿½';
    const ICON_EDIT = 'âœï¸';
    const ICON_DELETE = 'ðŸ—‘ï¸';
    const ICON_CALCULATE = 'âš™ï¸'; 
    const ICON_SAVE = 'ðŸ’¾';
    const ICON_CANCEL = 'âŒ';
    const ICON_SWAP = 'ðŸ”';
    const ICON_RESET = 'â†©ï¸';

    // --- Firebase Configuration and Initialization ---
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'dc-dark-legion-builder'; 
    const firebaseConfigProvided = { 
        apiKey: "AIzaSyAzSQbS4LtAz20syWI2HREPR7UnYh6ldbI", 
        authDomain: "dc-dark-legion-tools.firebaseapp.com",
        projectId: "dc-dark-legion-tools",
        storageBucket: "dc-dark-legion-tools.firebasestorage.app", 
        messagingSenderId: "786517074225",
        appId: "1:786517074225:web:9f14dc4dcae0705fcfd010",
        measurementId: "G-FTF00DHGV6"
    };
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : firebaseConfigProvided;
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    let app;
    let auth;
    let db;
    let userId; 
    let rosterDataTable = null; 
    let scoreColumnVisible = true; 
    let teamNameModalCallback = null; 
    let originalBestTeam = null; // To store the initially calculated best team
    let currentDisplayedTeam = null; // To store the team currently displayed (can be modified)
    let championToReplaceIndex = -1; // To store the index of the champion being swapped

    const loadingIndicatorEl = document.getElementById('loading-indicator');
    const errorIndicatorEl = document.getElementById('error-indicator');
    const errorMessageDetailsEl = document.getElementById('error-message-details');
    const saveRosterIndicatorEl = document.getElementById('save-roster-indicator');
    const toggleScoreColumnCheckbox = document.getElementById('toggle-score-column');
    const synergiesSectionEl = document.getElementById('synergies-section');
    const synergiesListEl = document.getElementById('synergies-list');
    const synergyChampionsModalEl = document.getElementById('synergy-champions-modal');
    const synergyModalTitleEl = document.getElementById('synergy-modal-title');
    const synergyModalBodyEl = document.getElementById('synergy-modal-body');
    const closeSynergyModalBtn = document.getElementById('close-synergy-modal-btn');
    const toastContainer = document.getElementById('toast-container');

    const teamNameModalEl = document.getElementById('team-name-modal');
    const teamNameModalTitleEl = document.getElementById('team-name-modal-title');
    const teamNameInputEl = document.getElementById('team-name-input');
    const saveTeamNameBtn = document.getElementById('save-team-name-btn');
    const cancelTeamNameBtn = document.getElementById('cancel-team-name-btn');

    const processingModalEl = document.getElementById('processing-modal');
    const processingStatusTextEl = document.getElementById('processing-status-text');
    const progressBarInnerEl = document.getElementById('progress-bar-inner');

    // Swap Champion Modal Elements
    const swapChampionModalEl = document.createElement('div'); // Will be created dynamically
    swapChampionModalEl.id = 'swap-champion-modal';
    swapChampionModalEl.className = 'modal-backdrop hidden';
    document.body.appendChild(swapChampionModalEl); // Add to body once

    // --- Toast Notification Function ---
    function showToast(message, type = 'info', duration = 3000) {
        if (!toastContainer) return;

        const toast = document.createElement('div');
        
        let baseClasses = 'toast mb-3 p-3 rounded-lg shadow-lg text-sm text-white flex justify-between items-center';
        let typeClasses = '';

        switch (type) {
            case 'success': typeClasses = 'bg-green-500'; break;
            case 'error':   typeClasses = 'bg-red-500';   break;
            case 'warning': typeClasses = 'bg-yellow-500 text-black'; break; 
            case 'info':
            default:        typeClasses = 'bg-blue-500';  break;
        }
        toast.className = `${baseClasses} ${typeClasses}`;
        
        const messageSpan = document.createElement('span');
        messageSpan.textContent = message;
        toast.appendChild(messageSpan);

        const closeBtn = document.createElement('button');
        closeBtn.innerHTML = '&times;';
        closeBtn.className = 'ml-2 text-lg font-semibold leading-none focus:outline-none'; 
        closeBtn.onclick = () => {
            toast.style.opacity = '0';
            setTimeout(() => toast.remove(), 500); 
        };
        toast.appendChild(closeBtn);

        toastContainer.appendChild(toast);

        toast.offsetHeight; 

        toast.classList.add('show');

        setTimeout(() => {
            toast.style.opacity = '0';
            setTimeout(() => toast.remove(), 500); 
        }, duration);
    }


    async function initializeFirebase() {
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);

            loadingIndicatorEl.classList.remove('hidden');
            errorIndicatorEl.classList.add('hidden');

            return new Promise((resolve, reject) => {
                const unsubscribe = onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdDisplay.textContent = `User ID: ${userId.substring(0,8)}...`; 
                        resolve();
                    } else {
                        try {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                await signInAnonymously(auth);
                            }
                        } catch (error) {
                            console.error("Error during sign-in:", error);
                            showError("Firebase Authentication failed: " + error.message);
                            userIdDisplay.textContent = "User ID: Firebase not configured";
                            reject(error); 
                        }
                    }
                }, (error) => { 
                    console.error("Auth state listener error:", error);
                    showError("Firebase Auth listener error: " + error.message);
                    reject(error); 
                });
            });

        } catch (error) {
            console.error("Error initializing Firebase:", error);
            showError("Firebase initialization failed: " + error.message);
            throw error; 
        }
    }
    
    function showError(message, details = "") {
        loadingIndicatorEl.classList.add('hidden');
        errorIndicatorEl.classList.remove('hidden');
        errorIndicatorEl.querySelector('p').textContent = message;
        errorMessageDetailsEl.textContent = details;
        showToast(message, 'error'); 
    }


    // --- Data Definitions (Client-side constants) ---
    const STAR_COLOR_TIERS = { 
        "White 1-Star": 1.0, "White 2-Star": 1.05, "White 3-Star": 1.10, "White 4-Star": 1.15, "White 5-Star": 1.20,
        "Blue 1-Star": 1.25, "Blue 2-Star": 1.30, "Blue 3-Star": 1.35, "Blue 4-Star": 1.40, "Blue 5-Star": 1.45,
        "Purple 1-Star": 1.50, "Purple 2-Star": 1.55, "Purple 3-Star": 1.60, "Purple 4-Star": 1.65, "Purple 5-Star": 1.70,
        "Gold 1-Star": 1.75, "Gold 2-Star": 1.80, "Gold 3-Star": 1.85, "Gold 4-Star": 1.90, "Gold 5-Star": 1.95,
        "Red 1-Star": 2.00, "Red 2-Star": 2.05, "Red 3-Star": 2.10, "Red 4-Star": 2.15, "Red 5-Star": 2.20
    };

    const CHAMPION_BASE_RARITY_SCORE = { 
        "Epic": 100, "Legendary": 150, "Mythic": 200, "Limited Mythic": 250
    };

    const STANDARD_GEAR_RARITIES = ["None", "Uncommon", "Rare", "Epic", "Legendary", "Mythic", "Mythic Enhanced"];
    const STANDARD_GEAR_RARITY_SCORE = {
        "None": 0, "Uncommon": 10, "Rare": 20, "Epic": 40, "Legendary": 70, "Mythic": 100, "Mythic Enhanced": 150
    };

    const LEGACY_PIECE_RARITY_SCORE = { 
        "None": 0, "Epic": 50, "Legendary": 80, "Mythic": 120, "Mythic+": 180
    };
    
    const CLASS_DIVERSITY_MULTIPLIER = 1.15; 
    const SYNERGY_ACTIVATION_COUNT = 3; 

    let dbSynergies = []; 
    let dbChampions = []; 
    let dbLegacyPieces = []; 
    let playerChampionRoster = []; 
    let currentSelectedChampionClass = null; 
    let editingChampionId = null; 
    let currentBestTeamForSaving = null; 
    let savedTeams = []; 

    // --- DOM Elements ---
    const formModeTitleEl = document.getElementById('form-mode-title');
    const champSelectDbEl = document.getElementById('champ-select-db');
    const champBaseRarityDisplayEl = document.getElementById('champ-base-rarity-display');
    const champClassDisplayEl = document.getElementById('champ-class-display'); 
    const champHealerStatusDisplayEl = document.getElementById('champ-healer-status-display'); 
    const champStarColorEl = document.getElementById('champ-star-color');
    const champInherentSynergiesDisplayEl = document.getElementById('champ-inherent-synergies-display');
    const gearSelectEls = {
        head: document.getElementById('gear-head'),
        arms: document.getElementById('gear-arms'),
        legs: document.getElementById('gear-legs'),
        chest: document.getElementById('gear-chest'),
        waist: document.getElementById('gear-waist'),
    };
    const legacyPieceSelectEl = document.getElementById('legacy-piece-select'); 
    const addUpdateChampionBtn = document.getElementById('add-update-champion-btn'); 
    const cancelEditBtn = document.getElementById('cancel-edit-btn'); 
    const championsRosterTableWrapperEl = document.getElementById('champions-roster-table-wrapper'); 
    const userIdDisplay = document.getElementById('userIdDisplay');
    const requireHealerCheckboxEl = document.getElementById('require-healer-checkbox'); 
    const excludeSavedTeamCheckboxEl = document.getElementById('exclude-saved-team-checkbox'); 
    const selectExclusionTeamDropdownEl = document.getElementById('select-exclusion-team-dropdown'); 
    const calculateBtn = document.getElementById('calculate-btn');
    const resultsOutputEl = document.getElementById('results-output');
    const savedTeamsListEl = document.getElementById('saved-teams-list'); 

    // --- Initialization Functions (Client-side options) ---
    function populateStarColorOptions() {
        Object.keys(STAR_COLOR_TIERS).forEach(tier => {
            const option = document.createElement('option');
            option.value = tier;
            option.textContent = tier;
            champStarColorEl.appendChild(option);
        });
    }

    function populateGearRarityOptions() {
        document.querySelectorAll('.gear-rarity-select').forEach(selectEl => {
            STANDARD_GEAR_RARITIES.forEach(rarity => {
                const option = document.createElement('option');
                option.value = rarity;
                option.textContent = rarity;
                selectEl.appendChild(option);
            });
        });
    }

    // --- Firestore Data Fetching & Synergy Rendering ---
    async function fetchSynergiesAndRender() { 
        try {
            const synergiesCollectionRef = collection(db, `artifacts/${appId}/public/data/synergies`);
            const querySnapshot = await getDocs(synergiesCollectionRef);
            dbSynergies = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a,b) => (a.name || "").localeCompare(b.name || ""));
            renderAvailableSynergies(); 
        } catch (error) {
            console.error("Error fetching synergies:", error);
            showError("Error fetching synergies from Firestore.", error.message);
            dbSynergies = []; 
            renderAvailableSynergies(); 
        }
    }

    function renderAvailableSynergies() {
        if (!synergiesListEl) return;
        synergiesListEl.innerHTML = ''; 

        if (dbSynergies.length === 0) {
            synergiesListEl.innerHTML = '<p class="text-sm text-gray-500 col-span-full">No synergies defined in the database.</p>';
            return;
        }

        dbSynergies.forEach(synergyDef => {
            const count = playerChampionRoster.filter(champ => (champ.inherentSynergies || []).includes(synergyDef.name)).length;
            const synergyItem = document.createElement('div');
            synergyItem.className = 'synergy-item'; 
            synergyItem.dataset.synergyName = synergyDef.name;

            const factionNameForIcon = synergyDef.name.trim().replace(/\s+/g, '_');
            
            const fallbackSpan = `<span class="icon-placeholder" style="display:none;">[${synergyDef.name}]</span>`;
            synergyItem.innerHTML = `
                <img src="img/factions/${factionNameForIcon}.png" alt="${synergyDef.name}" title="${synergyDef.name}" onerror="this.style.display='none'; const fb = this.parentElement.querySelector('.icon-placeholder'); if (fb) fb.style.display='inline-block';">
                ${fallbackSpan}
                <span class="synergy-name">${synergyDef.name}</span>
                <span class="synergy-progress">${count}/${SYNERGY_ACTIVATION_COUNT}</span>
            `;
            synergiesListEl.appendChild(synergyItem);
        });
    }


    async function fetchChampions() {
         try {
            const championsCollectionRef = collection(db, `artifacts/${appId}/public/data/champions`);
            const querySnapshot = await getDocs(championsCollectionRef);
            dbChampions = querySnapshot.docs.map(doc => {
                const data = doc.data();
                return { 
                    id: doc.id, 
                    ...data,
                    isHealer: data.isHealer === true 
                };
            }); 
        } catch (error) {
            console.error("Error fetching champions:", error);
            showError("Error fetching champions from Firestore.", error.message);
            dbChampions = [];
        }
    }

    async function fetchLegacyPieces() {
        try {
            const legacyPiecesCollectionRef = collection(db, `artifacts/${appId}/public/data/legacyPieces`);
            const querySnapshot = await getDocs(legacyPiecesCollectionRef);
            dbLegacyPieces = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            populateLegacyPieceSelect(); 
        } catch (error) {
            console.error("Error fetching legacy pieces:", error);
            showError("Error fetching legacy pieces from Firestore.", error.message);
            dbLegacyPieces = [];
            populateLegacyPieceSelect(); 
        }
    }
    
    function populateChampionSelect() {
        if (!champSelectDbEl) {
            console.error("FATAL: Champion select dropdown element (champ-select-db) not found in DOM!");
            return;
        }
        const currentSelectedValue = editingChampionId ? playerChampionRoster.find(c => c.id === editingChampionId)?.dbChampionId : champSelectDbEl.value; 
        champSelectDbEl.innerHTML = '<option value="">-- Select Champion --</option>'; 

        if (dbChampions.length === 0) {
            return;
        }
        
        const rosteredDbChampionIds = playerChampionRoster.map(rc => rc.dbChampionId);
        
        const availableChampions = dbChampions.filter(dbChamp => 
            !rosteredDbChampionIds.includes(dbChamp.id) || (editingChampionId && playerChampionRoster.find(c => c.id === editingChampionId)?.dbChampionId === dbChamp.id)
        );

        const sortedAvailableChampions = [...availableChampions].sort((a, b) => (a.name || "Unnamed Champion").localeCompare(b.name || "Unnamed Champion"));

        sortedAvailableChampions.forEach(champ => {
            if (!champ.id || !champ.name) { 
                console.warn("Champion data in dbChampions missing id or name, skipping:", JSON.stringify(champ)); 
                return; 
            }
            const option = document.createElement('option');
            option.value = champ.id; 
            option.textContent = champ.name;
            champSelectDbEl.appendChild(option);
        });

        if (availableChampions.some(champ => champ.id === currentSelectedValue)) {
            champSelectDbEl.value = currentSelectedValue;
        } else if (!editingChampionId) { 
            champBaseRarityDisplayEl.value = '';
            champClassDisplayEl.value = ''; 
            champHealerStatusDisplayEl.value = ''; 
            currentSelectedChampionClass = null; 
            champInherentSynergiesDisplayEl.textContent = 'Select a base champion to see synergies.';
        }
        populateLegacyPieceSelect(currentSelectedChampionClass);
    }

    function populateLegacyPieceSelect(championClass = null) {
        if (!legacyPieceSelectEl) {
            console.error("FATAL: Legacy Piece select dropdown element (legacy-piece-select) not found in DOM!");
            return;
        }
        const currentSelectedLegacyId = legacyPieceSelectEl.value; 
        legacyPieceSelectEl.innerHTML = '<option value="">-- None --</option>'; 
        
        if (dbLegacyPieces.length === 0) {
            return;
        }

        let filteredLegacyPieces = dbLegacyPieces;

        if (championClass && championClass !== "N/A") {
            const lowerChampionClass = championClass.toLowerCase();
            filteredLegacyPieces = dbLegacyPieces.filter(lp => {
                const description = (lp.description || "").toLowerCase();
                return description === "" || description.includes(lowerChampionClass);
            });
        } else {
             filteredLegacyPieces = dbLegacyPieces.filter(lp => {
                const description = (lp.description || "").toLowerCase();
                return description === ""; 
            });
        }

        const sortedLegacyPieces = [...filteredLegacyPieces].sort((a,b) => (a.name || "Unnamed LP").localeCompare(b.name || "Unnamed LP"));
        
        sortedLegacyPieces.forEach(lp => {
            if (!lp.id || !lp.name || !lp.baseRarity) { 
                 console.warn("Legacy Piece data in dbLegacyPieces missing id, name, or baseRarity, skipping:", JSON.stringify(lp));
                return;
            }
            const option = document.createElement('option');
            option.value = lp.id; 
            option.textContent = `${lp.name} (${lp.baseRarity})`;
            legacyPieceSelectEl.appendChild(option);
        });

        if (sortedLegacyPieces.some(lp => lp.id === currentSelectedLegacyId)) {
            legacyPieceSelectEl.value = currentSelectedLegacyId;
        }
    }


    champSelectDbEl.addEventListener('change', (event) => {
        const selectedChampionId = event.target.value;
        if (selectedChampionId) {
            const selectedDbChampion = dbChampions.find(c => c.id === selectedChampionId);
            if (selectedDbChampion) {
                champBaseRarityDisplayEl.value = selectedDbChampion.baseRarity || 'N/A';
                champClassDisplayEl.value = selectedDbChampion.class || 'N/A'; 
                champHealerStatusDisplayEl.value = selectedDbChampion.isHealer ? 'Yes' : 'No'; 
                currentSelectedChampionClass = selectedDbChampion.class || null; 
                champInherentSynergiesDisplayEl.textContent = (selectedDbChampion.inherentSynergies || []).join(', ') || 'None';
            } else {
                currentSelectedChampionClass = null;
                 champHealerStatusDisplayEl.value = '';
            }
        } else {
            champBaseRarityDisplayEl.value = '';
            champClassDisplayEl.value = ''; 
            champHealerStatusDisplayEl.value = '';
            currentSelectedChampionClass = null;
            champInherentSynergiesDisplayEl.textContent = 'Select a base champion to see synergies.';
        }
        populateLegacyPieceSelect(currentSelectedChampionClass); 
    });

    // --- Player Roster Save/Load ---
    async function savePlayerRosterToFirestore() {
        if (!userId) {
            console.error("Cannot save roster: User not authenticated.");
            showToast("Error: User not authenticated. Cannot save roster.", "error");
            return;
        }
        saveRosterIndicatorEl.classList.remove('hidden');
        addUpdateChampionBtn.disabled = true;

        try {
            const rosterDocRef = doc(db, `artifacts/${appId}/users/${userId}/roster/myRoster`);
            await setDoc(rosterDocRef, { champions: playerChampionRoster });
            showToast("Roster saved successfully!", "success");
        } catch (error) {
            console.error("Error saving player roster:", error);
            showToast("Failed to save your roster. Error: " + error.message, "error");
        } finally {
            saveRosterIndicatorEl.classList.add('hidden');
            addUpdateChampionBtn.disabled = false;
        }
    }

    async function loadPlayerRosterFromFirestore() {
        if (!userId) {
            return;
        }
        try {
            const rosterDocRef = doc(db, `artifacts/${appId}/users/${userId}/roster/myRoster`);
            const docSnap = await getDoc(rosterDocRef);

            if (docSnap.exists()) {
                const rosterData = docSnap.data();
                if (rosterData && Array.isArray(rosterData.champions)) {
                    playerChampionRoster = rosterData.champions.map(savedChamp => {
                        const baseDetails = dbChampions.find(dbChamp => dbChamp.id === savedChamp.dbChampionId);
                        return {
                            ...savedChamp, 
                            name: baseDetails ? baseDetails.name : savedChamp.name, 
                            baseRarity: baseDetails ? baseDetails.baseRarity : savedChamp.baseRarity,
                            class: baseDetails ? (baseDetails.class || "N/A") : (savedChamp.class || "N/A"),
                            isHealer: baseDetails ? (baseDetails.isHealer === true) : false, 
                            inherentSynergies: baseDetails ? (baseDetails.inherentSynergies || []) : (savedChamp.inherentSynergies || [])
                        };
                    });
                } else {
                    playerChampionRoster = [];
                }
            } else {
                playerChampionRoster = []; 
            }
            renderPlayerChampionRoster(); 
            renderAvailableSynergies(); // Update synergy display based on new roster
        } catch (error) {
            console.error("Error loading player roster:", error);
            showError("Error loading your saved roster.", error.message);
            playerChampionRoster = []; 
            renderPlayerChampionRoster(); 
            renderAvailableSynergies(); // Still render to show empty state
        }
    }

    // --- Edit Mode Functions ---
    function resetChampionForm() {
        champSelectDbEl.value = "";
        champSelectDbEl.disabled = false; 
        champBaseRarityDisplayEl.value = "";
        champClassDisplayEl.value = "";
        champHealerStatusDisplayEl.value = "";
        currentSelectedChampionClass = null;
        champStarColorEl.value = Object.keys(STAR_COLOR_TIERS)[0]; 
        champInherentSynergiesDisplayEl.textContent = 'Select a base champion to see synergies.';
        Object.values(gearSelectEls).forEach(sel => sel.value = STANDARD_GEAR_RARITIES[0]); 
        legacyPieceSelectEl.value = ""; 
        populateLegacyPieceSelect(null); 
        addUpdateChampionBtn.innerHTML = `<span class="btn-icon">${ICON_ADD}</span> <span class="btn-text">Add Champion to Roster</span> <span id="save-roster-indicator" class="saving-indicator hidden"></span>`;

    }

    window.editChampion = (championId) => {
        const championToEdit = playerChampionRoster.find(c => c.id === championId);
        if (!championToEdit) {
            console.error("Champion to edit not found in roster:", championId);
            return;
        }
        editingChampionId = championId;
        formModeTitleEl.textContent = "Edit Champion in Roster";

        champSelectDbEl.value = championToEdit.dbChampionId;
        champSelectDbEl.disabled = true; 

        champBaseRarityDisplayEl.value = championToEdit.baseRarity;
        champClassDisplayEl.value = championToEdit.class || "N/A";
        champHealerStatusDisplayEl.value = championToEdit.isHealer ? 'Yes' : 'No';
        currentSelectedChampionClass = championToEdit.class || null; 
        champStarColorEl.value = championToEdit.starColorTier;
        champInherentSynergiesDisplayEl.textContent = (championToEdit.inherentSynergies || []).join(', ') || 'None';

        gearSelectEls.head.value = championToEdit.gear.head.rarity;
        gearSelectEls.arms.value = championToEdit.gear.arms.rarity;
        gearSelectEls.legs.value = championToEdit.gear.legs.rarity;
        gearSelectEls.chest.value = championToEdit.gear.chest.rarity;
        gearSelectEls.waist.value = championToEdit.gear.waist.rarity;
        
        populateLegacyPieceSelect(currentSelectedChampionClass); 
        legacyPieceSelectEl.value = championToEdit.legacyPiece.id || "";

        addUpdateChampionBtn.innerHTML = `<span class="btn-icon">${ICON_UPDATE}</span> <span class="btn-text">Update Champion in Roster</span> <span id="save-roster-indicator" class="saving-indicator hidden"></span>`;
        cancelEditBtn.classList.remove('hidden');
        window.scrollTo({ top: champSelectDbEl.offsetTop - 125, behavior: 'smooth' }); 
    };

    function cancelEditMode() {
        editingChampionId = null;
        formModeTitleEl.textContent = "Add Your Champions to Roster";
        resetChampionForm(); 
        cancelEditBtn.classList.add('hidden');
        champSelectDbEl.disabled = false; 
        populateChampionSelect(); 
    }
    cancelEditBtn.addEventListener('click', cancelEditMode);


    // --- Player Champion Roster Management ---
    addUpdateChampionBtn.addEventListener('click', async () => { 
        if (editingChampionId) { 
            const championIndex = playerChampionRoster.findIndex(c => c.id === editingChampionId);
            if (championIndex === -1) {
                console.error("Could not find champion to update in roster.");
                showToast("Error: Champion to update not found.", "error");
                cancelEditMode(); 
                return;
            }

            const selectedLegacyPieceId = legacyPieceSelectEl.value;
            let legacyPieceData = { id: null, name: "None", rarity: "None", score: 0 }; 
            if (selectedLegacyPieceId) {
                const dbLp = dbLegacyPieces.find(lp => lp.id === selectedLegacyPieceId);
                if (dbLp) {
                    legacyPieceData = {
                        id: dbLp.id, name: dbLp.name, rarity: dbLp.baseRarity,
                        score: LEGACY_PIECE_RARITY_SCORE[dbLp.baseRarity] || 0, 
                        description: dbLp.description || ""
                    };
                }
            }
            
            const baseChampionDataForUpdate = dbChampions.find(dbChamp => dbChamp.id === playerChampionRoster[championIndex].dbChampionId);

            playerChampionRoster[championIndex] = {
                ...playerChampionRoster[championIndex], 
                isHealer: baseChampionDataForUpdate ? (baseChampionDataForUpdate.isHealer === true) : (playerChampionRoster[championIndex].isHealer === true), 
                starColorTier: champStarColorEl.value,
                gear: { 
                    head: { rarity: gearSelectEls.head.value, score: STANDARD_GEAR_RARITY_SCORE[gearSelectEls.head.value] || 0 },
                    arms: { rarity: gearSelectEls.arms.value, score: STANDARD_GEAR_RARITY_SCORE[gearSelectEls.arms.value] || 0 },
                    legs: { rarity: gearSelectEls.legs.value, score: STANDARD_GEAR_RARITY_SCORE[gearSelectEls.legs.value] || 0 },
                    chest: { rarity: gearSelectEls.chest.value, score: STANDARD_GEAR_RARITY_SCORE[gearSelectEls.chest.value] || 0 },
                    waist: { rarity: gearSelectEls.waist.value, score: STANDARD_GEAR_RARITY_SCORE[gearSelectEls.waist.value] || 0 },
                },
                legacyPiece: legacyPieceData, 
            };
            
            renderPlayerChampionRoster(); 
            await savePlayerRosterToFirestore(); 
            showToast(`${playerChampionRoster[championIndex].name} updated in roster!`, "success");
            cancelEditMode(); 

        } else { 
            const selectedDbChampionId = champSelectDbEl.value;
            if (!selectedDbChampionId) {
                showToast('Please select a base champion.', 'warning');
                return;
            }
            if (playerChampionRoster.some(rc => rc.dbChampionId === selectedDbChampionId)) {
                showToast('This champion is already in your roster.', 'warning');
                return; 
            }

            const baseChampionData = dbChampions.find(c => c.id === selectedDbChampionId);
            if (!baseChampionData) {
                showToast('Selected base champion data not found. Please try again.', 'error'); 
                return;
            }

            const selectedLegacyPieceId = legacyPieceSelectEl.value;
            let legacyPieceData = { id: null, name: "None", rarity: "None", score: 0 }; 
            if (selectedLegacyPieceId) {
                const dbLp = dbLegacyPieces.find(lp => lp.id === selectedLegacyPieceId);
                if (dbLp) {
                    legacyPieceData = {
                        id: dbLp.id, name: dbLp.name, rarity: dbLp.baseRarity, 
                        score: LEGACY_PIECE_RARITY_SCORE[dbLp.baseRarity] || 0, 
                        description: dbLp.description || ""
                    };
                }
            }

            const playerChampion = {
                id: Date.now(), 
                dbChampionId: baseChampionData.id, 
                name: baseChampionData.name,
                baseRarity: baseChampionData.baseRarity,
                class: baseChampionData.class || "N/A", 
                isHealer: baseChampionData.isHealer === true, 
                inherentSynergies: baseChampionData.inherentSynergies || [], 
                starColorTier: champStarColorEl.value, 
                gear: { 
                    head: { rarity: gearSelectEls.head.value },
                    arms: { rarity: gearSelectEls.arms.value },
                    legs: { rarity: gearSelectEls.legs.value },
                    chest: { rarity: gearSelectEls.chest.value },
                    waist: { rarity: gearSelectEls.waist.value },
                },
                legacyPiece: legacyPieceData, 
            };
            
            Object.keys(playerChampion.gear).forEach(slot => {
                playerChampion.gear[slot].score = STANDARD_GEAR_RARITY_SCORE[playerChampion.gear[slot].rarity] || 0; 
            });

            playerChampionRoster.push(playerChampion); 
            renderPlayerChampionRoster(); // This will also call renderAvailableSynergies
            await savePlayerRosterToFirestore(); 
            showToast(`${playerChampion.name} added to roster!`, "success");
            resetChampionForm(); 
            populateChampionSelect(); 
        }
    });

    // Helper function to get HTML for star rating
    function getStarRatingHTML(starColorTier) {
        if (!starColorTier || typeof starColorTier !== 'string') {
            return 'N/A';
        }
        const parts = starColorTier.match(/(\w+)\s*(\d+)-Star/);
        if (!parts || parts.length < 3) {
            return starColorTier; 
        }

        const colorName = parts[1].toLowerCase();
        const starCount = parseInt(parts[2], 10);
        let colorClass = '';

        switch (colorName) {
            case 'red':    colorClass = 'text-red-500'; break;
            case 'gold':   colorClass = 'text-yellow-400'; break; 
            case 'purple': colorClass = 'text-purple-500'; break;
            case 'blue':   colorClass = 'text-blue-500'; break;
            case 'white':  colorClass = 'text-slate-400'; break; 
            default:       colorClass = 'text-gray-500'; 
        }

        let starsHTML = `<div class="star-rating" title="${starColorTier}">`;
        for (let i = 0; i < starCount; i++) {
            starsHTML += `<span class="${colorClass}">â˜…</span>`;
        }
        starsHTML += `</div>`;
        return starsHTML;
    }


    // Helper function to get image HTML for healer status
    function getHealerPlaceholder() {
        const fallbackSpan = `<span class="icon-placeholder" style="display:none;">[H]</span>`;
        return `<span class="icon-wrapper"><img src="img/classes/Healer.png" alt="Healer" title="Healer" class="icon-class-table" onerror="this.style.display='none'; const fb = this.parentElement.querySelector('.icon-placeholder'); if (fb) fb.style.display='inline-block';"/>${fallbackSpan}</span>`;
    }

    // Helper function to get image HTML based on champion class
    function getClassPlaceholder(className) {
        const cn = (className || "N/A").trim().replace(/\s+/g, '_'); 
        if (cn === "N/A" || cn === "") {
            return `<span class="icon-placeholder">[Class N/A]</span>`;
        }
        const fallbackSpan = `<span class="icon-placeholder" style="display:none;">[${cn.replace(/_/g, ' ')}]</span>`;
        return `<span class="icon-wrapper"><img src="img/classes/${cn}.png" alt="${cn.replace(/_/g, ' ')}" title="${cn.replace(/_/g, ' ')}" class="icon-class-table" onerror="this.style.display='none'; const fb = this.parentElement.querySelector('.icon-placeholder'); if (fb) fb.style.display='inline-block';"/>${fallbackSpan}</span>`;
    }


    function renderPlayerChampionRoster() { 
        const rosterTableWrapper = document.getElementById('champions-roster-table-wrapper');
        if (!rosterTableWrapper) return;

        if (rosterDataTable) {
            rosterDataTable.clear().destroy(); 
            rosterDataTable = null;
        }
        rosterTableWrapper.innerHTML = ''; 

        if (playerChampionRoster.length === 0) {
            rosterTableWrapper.innerHTML = '<p class="text-sm text-gray-500">No champions added to your roster yet.</p>';
            renderAvailableSynergies(); 
            return;
        }

        const table = document.createElement('table');
        table.id = 'rosterTable'; 
        table.className = 'display min-w-full'; 
        const thead = document.createElement('thead');
        thead.innerHTML = `
            <tr>
                <th>Name</th>
                <th>Rarity</th>
                <th>Class</th>
                <th class="dt-column-score">Ind. Score</th>
                <th>Star/Color</th>
                <th>Legacy Piece</th>
                <th>Actions</th>
            </tr>
        `;
        table.appendChild(thead);

        const tbody = document.createElement('tbody');
        
        playerChampionRoster.forEach(champ => { 
            const tr = document.createElement('tr');
            const legacyDisplay = champ.legacyPiece && champ.legacyPiece.id ? `${champ.legacyPiece.name} (${champ.legacyPiece.rarity})` : "None";
            
            const displayHealerIcon = champ.isHealer ? getHealerPlaceholder() : '';
            const displayClassIcon = getClassPlaceholder(champ.class);
            const individualScore = Math.round(calculateIndividualChampionScore(champ)); 
            const starRatingHTML = getStarRatingHTML(champ.starColorTier);

            tr.innerHTML = `
                <td data-sort="${champ.name}"><div class="flex items-center">${displayHealerIcon}<span class="ml-1">${champ.name}</span></div></td>
                <td data-sort="${CHAMPION_BASE_RARITY_SCORE[champ.baseRarity] || 0}">${champ.baseRarity}</td>
                <td data-sort="${champ.class || 'N/A'}">${displayClassIcon}</td>
                <td class="dt-column-score" data-sort="${individualScore}">${individualScore}</td>
                <td data-sort="${STAR_COLOR_TIERS[champ.starColorTier] || 0}">${starRatingHTML}</td>
                <td data-sort="${LEGACY_PIECE_RARITY_SCORE[champ.legacyPiece.rarity] || 0}">${legacyDisplay}</td>
                <td>
                    <button class="btn btn-sm btn-warning text-xs mr-1" onclick="editChampion(${champ.id})"><span class="btn-icon">${ICON_EDIT}</span> Edit</button>
                    <button class="btn btn-sm btn-danger text-xs" onclick="removePlayerChampion(${champ.id})"><span class="btn-icon">${ICON_DELETE}</span> Remove</button>
                </td>
            `;
            tbody.appendChild(tr);
        });
        table.appendChild(tbody);
        rosterTableWrapper.appendChild(table);

        if (typeof $ !== 'undefined' && $.fn.DataTable) {
            rosterDataTable = new $('#rosterTable').DataTable({
                responsive: true,
                "columnDefs": [
                    { "targets": [0, 1, 2, 4, 5, 6], "type": "string" }, 
                    { "targets": 3, "type": "num", "className": "dt-column-score text-right" } 
                ],
                 "order": [[3, "desc"]] 
            });
            rosterDataTable.column('.dt-column-score').visible(scoreColumnVisible);
            toggleScoreColumnCheckbox.checked = scoreColumnVisible;
        } else {
            console.warn("jQuery or DataTables not loaded, roster table will not have advanced features.");
        }
        renderAvailableSynergies(); 
    }
    
    if (toggleScoreColumnCheckbox) {
        toggleScoreColumnCheckbox.addEventListener('change', function() {
            scoreColumnVisible = this.checked;
            if (rosterDataTable) {
                rosterDataTable.column('.dt-column-score').visible(scoreColumnVisible);
            }
        });
    }

    window.removePlayerChampion = async (championId) => { 
        if (editingChampionId === championId) { 
            cancelEditMode(); 
        }
        const champToRemove = playerChampionRoster.find(c => c.id === championId);
        if (champToRemove && confirm(`Are you sure you want to remove ${champToRemove.name} from your roster?`)) {
            playerChampionRoster = playerChampionRoster.filter(c => c.id !== championId);
            renderPlayerChampionRoster(); 
            await savePlayerRosterToFirestore(); 
            showToast(`${champToRemove.name} removed from roster.`, "info");
            populateChampionSelect();
        }
    }


    // --- Calculation Logic ---
    function calculateIndividualChampionScore(champion) { 
        let score = 0;
        const baseScore = CHAMPION_BASE_RARITY_SCORE[champion.baseRarity] || 0; 
        const starMultiplier = STAR_COLOR_TIERS[champion.starColorTier] || 1;
        
        score = baseScore * starMultiplier;
        if (champion.gear && typeof champion.gear === 'object') {
            Object.entries(champion.gear).forEach(([slot, g]) => { 
                const gearScore = (g && typeof g === 'object' && g.score) ? g.score : 0; 
                score += gearScore;
            });
        }
        const legacyScore = (champion.legacyPiece && typeof champion.legacyPiece === 'object' && champion.legacyPiece.score) ? champion.legacyPiece.score : 0; 
        score += legacyScore;
        return score;
    }

    function generateCombinations(array, k) {
        const result = [];
        function backtrack(startIndex, currentCombination) {
            if (currentCombination.length === k) {
                result.push([...currentCombination]);
                return;
            }
            for (let i = startIndex; i < array.length; i++) {
                currentCombination.push(array[i]);
                backtrack(i + 1, currentCombination);
                currentCombination.pop();
            }
        }
        backtrack(0, []);
        return result;
    }
    
    // --- Processing Modal Functions ---
    function openProcessingModal() {
        if (!processingModalEl) return;
        updateProcessingStatus("Initializing calculation...", 0);
        processingModalEl.classList.remove('hidden');
        processingModalEl.classList.add('active');
    }

    function closeProcessingModal() {
        if (!processingModalEl) return;
        processingModalEl.classList.add('hidden');
        processingModalEl.classList.remove('active');
    }

    function updateProcessingStatus(statusText, progressPercentage) {
        if (processingStatusTextEl) {
            processingStatusTextEl.textContent = statusText;
        }
        if (progressBarInnerEl) {
            progressBarInnerEl.style.width = `${progressPercentage}%`;
        }
    }


    calculateBtn.addEventListener('click', () => {
        if (editingChampionId) {
            showToast("Please finish or cancel editing the current champion before calculating.", "warning");
            return;
        }
        if (playerChampionRoster.length < 5) {
            resultsOutputEl.innerHTML = '<p class="text-red-500">You need at least 5 champions in your roster to form a team.</p>';
            return;
        }
        if (dbSynergies.length === 0) {
             resultsOutputEl.innerHTML = '<p class="text-orange-500">Warning: No synergies loaded from DB. Calculation will proceed without synergy bonuses.</p>';
        }

        openProcessingModal();
        updateProcessingStatus("Preparing roster for calculation...", 2);
        
        let rosterForCombination = playerChampionRoster.map(rosterChamp => { 
            const baseChampData = dbChampions.find(dbChamp => dbChamp.id === rosterChamp.dbChampionId);
            return {
                ...rosterChamp,
                isHealer: baseChampData ? (baseChampData.isHealer === true) : false, 
                individualScore: calculateIndividualChampionScore(rosterChamp) 
            };
        });
        
        const excludeChampions = excludeSavedTeamCheckboxEl.checked;
        const exclusionTeamId = selectExclusionTeamDropdownEl.value;
        let championsToExcludeIds = new Set();

        if (excludeChampions && exclusionTeamId) { 
            if (exclusionTeamId === "ALL_SAVED_TEAMS") {
                savedTeams.forEach(savedTeam => {
                    if (savedTeam.members && Array.isArray(savedTeam.members)) {
                        savedTeam.members.forEach(member => championsToExcludeIds.add(member.dbChampionId));
                    }
                });
            } else { 
                const teamToExclude = savedTeams.find(st => st.id === exclusionTeamId);
                if (teamToExclude && teamToExclude.members) {
                    teamToExclude.members.forEach(member => championsToExcludeIds.add(member.dbChampionId));
                }
            }
        }
        

        if (championsToExcludeIds.size > 0) {
            rosterForCombination = rosterForCombination.filter(champ => !championsToExcludeIds.has(champ.dbChampionId));
            if (rosterForCombination.length < 5) {
                updateProcessingStatus("Error: Not enough champions after exclusion.", 100);
                resultsOutputEl.innerHTML = '<p class="text-red-500">After excluding champions, there are not enough remaining champions in your roster to form a team of 5.</p>';
                setTimeout(closeProcessingModal, 1500);
                return;
            }
        }

        updateProcessingStatus("Generating team combinations...", 5);
        let teamCombinations = [];
        const requireHealer = requireHealerCheckboxEl.checked;

        if (requireHealer) {
            const healers = rosterForCombination.filter(champ => champ.isHealer === true);
            if (healers.length === 0) {
                updateProcessingStatus("Error: No healers found for 'Require Healer'.", 100);
                resultsOutputEl.innerHTML = '<p class="text-red-500">No healers found in the available roster to meet the "Require Healer" criteria. Cannot form a team.</p>';
                setTimeout(closeProcessingModal, 1500);
                return;
            }
            if (rosterForCombination.length < 5) { 
                updateProcessingStatus("Error: Not enough champions for a team with a healer.", 100);
                resultsOutputEl.innerHTML = `<p class="text-red-500">Not enough champions in the available roster to form a team of 5 with a healer.</p>`;
                setTimeout(closeProcessingModal, 1500);
                return;
            }
            healers.forEach(healer => {
                const otherChamps = rosterForCombination.filter(champ => champ.id !== healer.id); 
                if (otherChamps.length >= 4) { 
                    const combinationsOfFour = generateCombinations(otherChamps, 4);
                    combinationsOfFour.forEach(combo => {
                        teamCombinations.push([healer, ...combo]); 
                    });
                }
            });
             if (teamCombinations.length === 0 && healers.length > 0) { 
                updateProcessingStatus("Error: Not enough other champions to form team with healer.", 100);
                resultsOutputEl.innerHTML = '<p class="text-red-500">Not enough other champions in the available roster to form a valid team of 5 with any available healer.</p>';
                setTimeout(closeProcessingModal, 1500);
                return;
            }
        } else { 
            teamCombinations = generateCombinations(rosterForCombination, 5);
        }
        
        if (teamCombinations.length === 0) {
            updateProcessingStatus("Error: Could not generate any valid teams.", 100);
            resultsOutputEl.innerHTML = '<p class="text-red-500">Could not generate any valid teams with the current criteria.</p>';
            setTimeout(closeProcessingModal, 1500);
            return;
        }
        
        updateProcessingStatus(`Generated ${teamCombinations.length} combinations. Evaluating...`, 10);

        let bestTeam = null;
        let maxScore = -1; 

        setTimeout(() => { 
            teamCombinations.forEach((team, index) => {
                const progress = 10 + Math.round(((index + 1) / teamCombinations.length) * 85); 
                if (index % Math.max(1, Math.floor(teamCombinations.length / 20)) === 0) { 
                     updateProcessingStatus(`Evaluating team ${index + 1} of ${teamCombinations.length}...`, progress);
                }

                const currentTeamBaseScoreSum = team.reduce((sum, member) => sum + member.individualScore, 0);
                let scoreAfterPercentageSynergies = currentTeamBaseScoreSum;
                let totalPercentageBonusAppliedValue = 0;
                let accumulatedBaseFlatBonus = 0;
                let accumulatedTieredFlatBonus = 0;
                const activeSynergiesForTeamCalculation = [];

                const sortedSynergyDefs = [...dbSynergies].sort((a, b) => {
                    if (a.bonusType === 'percentage' && b.bonusType !== 'percentage') return -1;
                    if (a.bonusType !== 'percentage' && b.bonusType === 'percentage') return 1;
                    return 0;
                });

                sortedSynergyDefs.forEach(synergyDef => {
                    const membersWithSynergy = team.filter(member => (member.inherentSynergies || []).includes(synergyDef.name));
                    const memberCount = membersWithSynergy.length;

                    if (memberCount >= SYNERGY_ACTIVATION_COUNT) {
                        let primaryBonusAppliedThisSynergy = 0;
                        let tieredFlatBonusAppliedThisSynergy = 0;

                        if (synergyDef.bonusValue !== undefined && synergyDef.bonusValue !== null) {
                            if (synergyDef.bonusType === 'percentage') {
                                const bonusValue = scoreAfterPercentageSynergies * (synergyDef.bonusValue / 100);
                                totalPercentageBonusAppliedValue += bonusValue; 
                                scoreAfterPercentageSynergies += bonusValue;
                                primaryBonusAppliedThisSynergy = synergyDef.bonusValue; 
                            } else if (synergyDef.bonusType === 'flat') {
                                accumulatedBaseFlatBonus += synergyDef.bonusValue;
                                primaryBonusAppliedThisSynergy = synergyDef.bonusValue;
                            }
                        }

                        if (memberCount === 3) tieredFlatBonusAppliedThisSynergy = 25000;
                        else if (memberCount === 4) tieredFlatBonusAppliedThisSynergy = 100000;
                        else if (memberCount >= 5) tieredFlatBonusAppliedThisSynergy = 250000;
                        accumulatedTieredFlatBonus += tieredFlatBonusAppliedThisSynergy;
                        
                        activeSynergiesForTeamCalculation.push({
                            name: synergyDef.name,
                            bonusType: synergyDef.bonusType,
                            primaryBonusApplied: primaryBonusAppliedThisSynergy, 
                            tieredFlatBonusApplied: tieredFlatBonusAppliedThisSynergy,
                            description: synergyDef.description || '',
                            appliedAtMemberCount: memberCount
                        });
                    }
                });

                const totalFlatSynergyBonusComponent = accumulatedBaseFlatBonus + accumulatedTieredFlatBonus;
                const subtotalAfterSynergies = scoreAfterPercentageSynergies + totalFlatSynergyBonusComponent;
                
                const uniqueClassesInTeam = new Set(team.map(m => m.class).filter(c => c && c !== "N/A"));
                let classDiversityBonusValue = 0;
                let finalTeamScore = subtotalAfterSynergies;
                let classDiversityBonusApplied = false;

                if (uniqueClassesInTeam.size >= 4) {
                    classDiversityBonusValue = subtotalAfterSynergies * (CLASS_DIVERSITY_MULTIPLIER - 1);
                    finalTeamScore += classDiversityBonusValue;
                    classDiversityBonusApplied = true;
                }

                if (finalTeamScore > maxScore) {
                    maxScore = finalTeamScore;
                    bestTeam = {
                        members: team,
                        totalScore: finalTeamScore,
                        activeSynergies: activeSynergiesForTeamCalculation,
                        baseScoreSum: currentTeamBaseScoreSum,
                        uniqueClassesCount: uniqueClassesInTeam.size,
                        classDiversityBonusApplied: classDiversityBonusApplied,
                        scoreBreakdown: { 
                            base: currentTeamBaseScoreSum,
                            percentageSynergyBonus: totalPercentageBonusAppliedValue,
                            flatSynergyBonus: totalFlatSynergyBonusComponent,
                            subtotalAfterSynergies: subtotalAfterSynergies,
                            classDiversityBonus: classDiversityBonusValue,
                        }
                    };
                }
            });
            updateProcessingStatus("Finalizing best team...", 99);
            displayResults(bestTeam); // This now calls renderTeamDisplay internally
            updateProcessingStatus("Calculation complete!", 100);
            setTimeout(closeProcessingModal, 1000); 
        }, 100); 
    });

    function displayResults(teamToDisplay) {
        if (!teamToDisplay || !teamToDisplay.scoreBreakdown) { 
            resultsOutputEl.innerHTML = '<p class="text-red-500">No optimal team could be determined or score breakdown is missing.</p>';
            currentBestTeamForSaving = null; 
            originalBestTeam = null;
            currentDisplayedTeam = null;
            return;
        }
        
        originalBestTeam = JSON.parse(JSON.stringify(teamToDisplay)); // Store the initial best team
        currentDisplayedTeam = JSON.parse(JSON.stringify(teamToDisplay)); // Set current display
        currentBestTeamForSaving = JSON.parse(JSON.stringify(teamToDisplay)); // For the save button

        renderTeamDisplay(currentDisplayedTeam, true); // Render with swap buttons
    }

    function renderTeamDisplay(teamObject, isModifiable = true) {
        if (!teamObject || !teamObject.scoreBreakdown) {
             resultsOutputEl.innerHTML = '<p class="text-red-500">Error rendering team display: Invalid team data.</p>';
             return;
        }
        const breakdown = teamObject.scoreBreakdown;
        let html = `<h3 class="text-xl font-semibold text-indigo-700 mb-3">Optimal Team ${isModifiable && originalBestTeam && JSON.stringify(teamObject.members.map(m=>m.id)) !== JSON.stringify(originalBestTeam.members.map(m=>m.id)) ? '(Modified)' : ''}</h3>`;
        
        html += `<div class="mb-4 p-3 bg-indigo-50 border border-indigo-200 rounded-lg text-sm">`;
        html += `<h4 class="text-md font-semibold text-indigo-600 mb-2">Score Calculation:</h4>`;
        html += `<p>Base Individual Scores Sum: <strong class="float-right">${Math.round(breakdown.base)}</strong></p>`;
        if (breakdown.percentageSynergyBonus > 0) {
             html += `<p>Total Percentage Synergy Bonus: <strong class="text-green-600 float-right">+${Math.round(breakdown.percentageSynergyBonus)}</strong></p>`;
        }
        if (breakdown.flatSynergyBonus > 0) {
            html += `<p>Total Flat Synergy Bonuses: <strong class="text-green-600 float-right">+${Math.round(breakdown.flatSynergyBonus)}</strong></p>`;
        }
        html += `<p class="border-t border-indigo-200 pt-1 mt-1">Subtotal After Synergies: <strong class="float-right">${Math.round(breakdown.subtotalAfterSynergies)}</strong></p>`;
        if (teamObject.classDiversityBonusApplied) {
            html += `<p>Class Diversity Bonus (x${CLASS_DIVERSITY_MULTIPLIER}): <strong class="text-green-600 float-right">+${Math.round(breakdown.classDiversityBonus)}</strong></p>`;
        }
        html += `<p class="border-t border-indigo-200 pt-1 mt-1 font-bold text-indigo-700">Final Team Score: <strong class="float-right">${Math.round(teamObject.totalScore)}</strong></p>`;
        html += `</div>`;

        html += `<h4 class="text-md font-semibold text-gray-700 mt-3 mb-1">Score Contribution:</h4>`;
        html += `<div class="score-chart-container mb-2">`;
        const totalScoreForChart = teamObject.totalScore > 0 ? teamObject.totalScore : 1; 
        
        const basePct = (breakdown.base / totalScoreForChart) * 100;
        const percSynPct = (breakdown.percentageSynergyBonus / totalScoreForChart) * 100;
        const flatSynPct = (breakdown.flatSynergyBonus / totalScoreForChart) * 100;
        const classDivPct = (breakdown.classDiversityBonus / totalScoreForChart) * 100;

        if (basePct > 0) html += `<div class="score-chart-segment bg-blue-500" style="width:${basePct.toFixed(1)}%;" title="Base: ${Math.round(breakdown.base)}"></div>`;
        if (percSynPct > 0) html += `<div class="score-chart-segment bg-green-500" style="width:${percSynPct.toFixed(1)}%;" title="Perc. Synergy: +${Math.round(breakdown.percentageSynergyBonus)}"></div>`;
        if (flatSynPct > 0) html += `<div class="score-chart-segment bg-teal-500" style="width:${flatSynPct.toFixed(1)}%;" title="Flat Synergy: +${Math.round(breakdown.flatSynergyBonus)}"></div>`;
        if (classDivPct > 0) html += `<div class="score-chart-segment bg-purple-500" style="width:${classDivPct.toFixed(1)}%;" title="Class Div.: +${Math.round(breakdown.classDiversityBonus)}"></div>`;
        html += `</div>`;
        html += `<div class="flex justify-around mb-4">
                    ${basePct > 0 ? '<span class="score-chart-segment-label"><span class="inline-block w-3 h-3 bg-blue-500 rounded-sm mr-1"></span>Base</span>' : ''}
                    ${percSynPct > 0 ? '<span class="score-chart-segment-label"><span class="inline-block w-3 h-3 bg-green-500 rounded-sm mr-1"></span>% Syn.</span>' : ''}
                    ${flatSynPct > 0 ? '<span class="score-chart-segment-label"><span class="inline-block w-3 h-3 bg-teal-500 rounded-sm mr-1"></span>Flat Syn.</span>' : ''}
                    ${classDivPct > 0 ? '<span class="score-chart-segment-label"><span class="inline-block w-3 h-3 bg-purple-500 rounded-sm mr-1"></span>Class Div.</span>' : ''}
                 </div>`;
        
        html += `<p class="mb-2"><strong class="text-gray-700">Unique Classes in Team:</strong> ${teamObject.uniqueClassesCount} (${teamObject.members.map(m=>m.class || 'N/A').filter((v,i,a)=>a.indexOf(v)===i && v !== "N/A").join(', ') || 'None'})</p>`;
        let hasHealer = teamObject.members.some(member => member.isHealer === true);
        html += `<p class="mb-4"><strong class="text-gray-700">Team Contains Healer:</strong> <span class="${hasHealer ? 'text-green-600 font-semibold' : 'text-red-600'}">${hasHealer ? 'Yes' : 'No'}</span></p>`;
        
        html += `<h4 class="text-lg font-medium text-gray-700 mt-4 mb-2">Team Members:</h4>`;
        html += `<div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-3 mb-4">`; 

        teamObject.members.forEach((member, index) => {
            const classNameForIcon = (member.class && member.class !== "N/A") ? member.class.trim().replace(/\s+/g, '_') : "UnknownClass"; 
            const healerIconHtml = member.isHealer ? `<span class="icon-wrapper"><img src="img/classes/Healer.png" alt="Healer" title="Healer" class="result-icon class-icon ml-1" onerror="this.style.display='none'; const fb = this.parentElement.querySelector('.icon-placeholder'); if (fb) fb.style.display='inline-block';"><span class="icon-placeholder text-xs" style="display:none;">[H]</span></span>` : '';
            const starRatingHTML = getStarRatingHTML(member.starColorTier);
            const swapButtonHtml = isModifiable ? `<button class="btn btn-sm btn-outline btn-info mt-2 w-full" onclick="handleOpenSwapModal(${index})"><span class="btn-icon">${ICON_SWAP}</span> Swap</button>` : '';


            html += `<div class="p-3 border rounded-lg shadow-md bg-slate-50 flex flex-col justify-between champion-card">`; 
            html += `   <div>`; // Wrapper for content above button
            html += `       <div class="flex items-center mb-2">`;
            html += `           <span class="icon-wrapper"><img src="img/classes/${classNameForIcon}.png" alt="${member.class || 'N/A'}" title="${member.class || 'N/A'}" class="result-icon class-icon mr-2" onerror="this.style.display='none'; const fb = this.parentElement.querySelector('.icon-placeholder'); if (fb) fb.style.display='inline-block';">`;
            html += `           <span class="icon-placeholder text-xs" style="display:none;">[${member.class || 'N/A'}]</span></span>`; 
            html += `           <strong class="text-sm text-slate-800 leading-tight">${member.name}</strong>`;
            html += healerIconHtml; 
            html += `       </div>`;
            html += `       <div class="text-xs text-slate-600 mb-2">`;
            html += `           <p>Tier: ${starRatingHTML}</p>`; 
            html += `           <p>Ind. Score: ${Math.round(member.individualScore)}</p>`;
            html += `       </div>`;
            if (member.inherentSynergies && member.inherentSynergies.length > 0) {
                html += `   <div class="mt-1">`; 
                html += `       <p class="text-xs font-semibold text-slate-500 mb-1">Synergies:</p>`;
                html += `       <div class="flex flex-wrap gap-1">`;
                member.inherentSynergies.forEach(synergy => {
                    const synergyNameForIcon = synergy.trim().replace(/\s+/g, '_'); 
                    html += `       <span class="icon-wrapper"><img src="img/factions/${synergyNameForIcon}.png" alt="${synergy}" title="${synergy}" class="result-icon w-5 h-5" onerror="this.style.display='none'; const fb = this.parentElement.querySelector('.icon-placeholder'); if (fb) fb.style.display='inline-block';">`;
                    html += `       <span class="icon-placeholder text-xs" style="display:none;">[${synergy}]</span></span>`; 
                });
                html += `       </div></div>`;
            }
            html += `   </div>`; // End content wrapper
            html += `   ${swapButtonHtml}`; // Add swap button if modifiable
            html += `</div>`; 
        });
        html += `</div>`; 

        if (teamObject.activeSynergies.length > 0) {
            html += `<h4 class="text-lg font-medium text-gray-700 mt-6 mb-2">Active Team Synergies:</h4><ul class="list-disc list-inside space-y-1 text-sm">`;
            teamObject.activeSynergies.forEach(synergy => {
                let bonusDisplay = "";
                if (synergy.bonusType === 'percentage' && synergy.primaryBonusApplied !== 0) {
                    bonusDisplay += `${synergy.primaryBonusApplied}% (base)`;
                } else if (synergy.bonusType === 'flat' && synergy.primaryBonusApplied !== 0) {
                    bonusDisplay += `+${synergy.primaryBonusApplied} flat (base)`;
                }

                if (synergy.tieredFlatBonusApplied > 0) {
                    if (bonusDisplay.length > 0) bonusDisplay += " & ";
                    bonusDisplay += `+${synergy.tieredFlatBonusApplied} flat (tier)`;
                }
                
                html += `<li><strong>${synergy.name}</strong> (${synergy.appliedAtMemberCount} members): ${bonusDisplay || 'No direct bonus value'}. ${synergy.description ? `(${synergy.description})` : ''}</li>`;
            });
            html += `</ul>`;
        } else {
            html += `<p class="text-gray-600 mt-6">No team synergies were active for this team, or no synergies loaded from DB.</p>`;
        }
        
        html += `<div class="mt-6 flex gap-2">`;
        html += `  <button id="save-team-btn" class="btn btn-success"><span class="btn-icon">${ICON_SAVE}</span> <span class="btn-text">Save This Team</span></button>`;
        if (isModifiable && originalBestTeam && JSON.stringify(teamObject.members.map(m=>m.id)) !== JSON.stringify(originalBestTeam.members.map(m=>m.id))) {
             html += `<button id="reset-team-btn" class="btn btn-outline btn-info"><span class="btn-icon">${ICON_RESET}</span> Reset to Original</button>`;
        }
        html += `</div>`;

        resultsOutputEl.innerHTML = html;

        const saveTeamBtn = document.getElementById('save-team-btn');
        if (saveTeamBtn) {
            saveTeamBtn.addEventListener('click', saveCurrentBestTeam);
        }
        const resetTeamBtn = document.getElementById('reset-team-btn');
        if (resetTeamBtn) {
            resetTeamBtn.addEventListener('click', handleResetTeam);
        }
    }

    // --- Saved Teams Management ---
    
    // Function to open the team name modal
    function openTeamNameModal(currentName = '', title = 'Enter Team Name', callback) {
        teamNameModalTitleEl.textContent = title;
        teamNameInputEl.value = currentName;
        teamNameModalCallback = callback; // Store the callback
        teamNameModalEl.classList.remove('hidden');
        teamNameModalEl.classList.add('active');
        teamNameInputEl.focus();
    }

    // Function to close the team name modal
    function closeTeamNameModal() {
        teamNameModalEl.classList.add('hidden');
        teamNameModalEl.classList.remove('active');
        teamNameInputEl.value = ''; // Clear input
        teamNameModalCallback = null; // Clear callback
    }

    // Event listener for the "Save Name" button in the team name modal
    if (saveTeamNameBtn) {
        saveTeamNameBtn.addEventListener('click', () => {
            const teamName = teamNameInputEl.value.trim();
            if (teamName === "") {
                showToast("Team name cannot be empty.", "warning");
                return;
            }
            if (teamNameModalCallback) {
                teamNameModalCallback(teamName); // Execute the stored callback
            }
            closeTeamNameModal();
        });
    }
    
    // Event listener for the "Cancel" button in the team name modal
    if (cancelTeamNameBtn) {
        cancelTeamNameBtn.addEventListener('click', closeTeamNameModal);
    }

    // Event listener for backdrop click on team name modal
    if (teamNameModalEl) {
        teamNameModalEl.addEventListener('click', (event) => {
            if (event.target === teamNameModalEl) {
                closeTeamNameModal();
            }
        });
    }


    async function saveCurrentBestTeam() {
        if (!userId) {
            showToast("You must be signed in to save teams.", "error");
            return;
        }
        if (!currentDisplayedTeam) { // Use currentDisplayedTeam as it might have been swapped
            showToast("No current team to save. Please calculate a team first.", "warning");
            return;
        }

        const defaultTeamName = `Team (Score: ${Math.round(currentDisplayedTeam.totalScore)}) - ${new Date().toLocaleDateString()}`;
        
        openTeamNameModal(defaultTeamName, 'Save Team As', async (teamNameToSave) => {
            const teamDataToSave = {
                name: teamNameToSave,
                members: currentDisplayedTeam.members.map(m => ({ 
                    dbChampionId: m.dbChampionId, 
                    name: m.name,
                    baseRarity: m.baseRarity,
                    class: m.class,
                    isHealer: m.isHealer === true, 
                    starColorTier: m.starColorTier,
                    gear: m.gear, 
                    legacyPiece: m.legacyPiece,
                    inherentSynergies: m.inherentSynergies || [],
                    individualScore: m.individualScore 
                })),
                totalScore: currentDisplayedTeam.totalScore,
                activeSynergies: currentDisplayedTeam.activeSynergies, 
                scoreBreakdown: currentDisplayedTeam.scoreBreakdown, 
                baseScoreSum: currentDisplayedTeam.baseScoreSum, 
                uniqueClassesCount: currentDisplayedTeam.uniqueClassesCount,
                classDiversityBonusApplied: currentDisplayedTeam.classDiversityBonusApplied,
                createdAt: new Date().toISOString() 
            };
            
            const saveTeamBtn = document.getElementById('save-team-btn'); 
            if(saveTeamBtn) saveTeamBtn.disabled = true; 

            try {
                const savedTeamsCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/savedTeams`);
                await addDoc(savedTeamsCollectionRef, teamDataToSave); 
                showToast("Team saved successfully!", "success");
                loadSavedTeams(); 
            } catch (error) {
                console.error("Error saving team:", error);
                showToast("Failed to save team. Error: " + error.message, "error");
            } finally {
                 if(saveTeamBtn) saveTeamBtn.disabled = false; 
            }
        });
    }

    async function loadSavedTeams() {
        if (!userId) return;
        try {
            const savedTeamsCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/savedTeams`);
            const q = query(savedTeamsCollectionRef, orderBy("createdAt", "desc")); 
            const querySnapshot = await getDocs(q);
            savedTeams = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderSavedTeams(); 
        } catch (error) {
            console.error("Error loading saved teams:", error);
            savedTeamsListEl.innerHTML = `<p class="text-red-500">Error loading saved teams.</p>`;
        }
    }

    function renderSavedTeams() {
        savedTeamsListEl.innerHTML = ''; 
        selectExclusionTeamDropdownEl.innerHTML = '<option value="">-- Select Saved Team to Exclude --</option>'; 
        
        const allTeamsOption = document.createElement('option');
        allTeamsOption.value = "ALL_SAVED_TEAMS";
        allTeamsOption.textContent = "-- All Saved Teams --";
        selectExclusionTeamDropdownEl.appendChild(allTeamsOption);


        if (savedTeams.length === 0) {
            savedTeamsListEl.innerHTML = '<p class="text-sm text-gray-500">No teams saved yet.</p>';
            return;
        }

        savedTeams.forEach(team => {
            const teamContainerDiv = document.createElement('div');
            teamContainerDiv.className = 'p-4 border rounded-lg bg-white shadow-lg mb-6'; 

            let teamHeaderHtml = `
                <div class="flex justify-between items-center mb-3 pb-2 border-b border-gray-200">
                    <div>
                        <h4 class="font-semibold text-lg text-indigo-700">${team.name}</h4>
                        <p class="text-sm text-gray-600">Total Score: <strong class="text-pink-600">${Math.round(team.totalScore)}</strong></p>
                    </div>
                    <div class="flex-shrink-0 space-x-1">
                         <button class="btn btn-sm btn-warning text-xs" onclick="renameSavedTeam('${team.id}', '${team.name.replace(/'/g, "\\'")}')"><span class="btn-icon">${ICON_EDIT}</span> Rename</button>
                         <button class="btn btn-sm btn-danger text-xs" onclick="deleteSavedTeam('${team.id}')"><span class="btn-icon">${ICON_DELETE}</span> Delete</button>
                    </div>
                </div>
            `;
            teamContainerDiv.innerHTML = teamHeaderHtml;

            const membersGridDiv = document.createElement('div');
            membersGridDiv.className = 'grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-3';

            if (team.members && Array.isArray(team.members)) {
                team.members.forEach(member => {
                    const classNameForIcon = (member.class && member.class !== "N/A") ? member.class.trim().replace(/\s+/g, '_') : "UnknownClass";
                    const healerIconHtml = member.isHealer ? `<span class="icon-wrapper"><img src="img/classes/Healer.png" alt="Healer" title="Healer" class="result-icon class-icon ml-1" onerror="this.style.display='none'; const fb = this.parentElement.querySelector('.icon-placeholder'); if (fb) fb.style.display='inline-block';"><span class="icon-placeholder text-xs" style="display:none;">[H]</span></span>` : '';
                    const starRatingHTML = getStarRatingHTML(member.starColorTier);
                    
                    let individualScore = member.individualScore;
                    if (individualScore === undefined) {
                        const baseChampDetails = dbChampions.find(c => c.id === member.dbChampionId) || {};
                        const memberForScoreCalc = { 
                            ...member,
                            baseRarity: member.baseRarity || baseChampDetails.baseRarity,
                        };
                        individualScore = calculateIndividualChampionScore(memberForScoreCalc);
                    }


                    let memberCardHtml = `<div class="p-3 border rounded-lg shadow-md bg-slate-50 flex flex-col justify-between champion-card">`;
                    
                    memberCardHtml += `<div class="flex items-center mb-2">`;
                    memberCardHtml += `<span class="icon-wrapper"><img src="img/classes/${classNameForIcon}.png" alt="${member.class || 'N/A'}" title="${member.class || 'N/A'}" class="result-icon class-icon mr-2" onerror="this.style.display='none'; const fb = this.parentElement.querySelector('.icon-placeholder'); if (fb) fb.style.display='inline-block';">`;
                    memberCardHtml += `<span class="icon-placeholder text-xs" style="display:none;">[${member.class || 'N/A'}]</span></span>`;
                    memberCardHtml += `<strong class="text-sm text-slate-800 leading-tight">${member.name}</strong>`;
                    memberCardHtml += healerIconHtml;
                    memberCardHtml += `</div>`;

                    memberCardHtml += `<div class="text-xs text-slate-600 mb-2">`;
                    memberCardHtml += `<p>Tier: ${starRatingHTML}</p>`;
                    memberCardHtml += `<p>Score: ${Math.round(individualScore)}</p>`;
                    memberCardHtml += `</div>`;

                    if (member.inherentSynergies && member.inherentSynergies.length > 0) {
                        memberCardHtml += `<div class="mt-auto">`;
                        memberCardHtml += `<p class="text-xs font-semibold text-slate-500 mb-1">Synergies:</p>`;
                        memberCardHtml += `<div class="flex flex-wrap gap-1">`;
                        member.inherentSynergies.forEach(synergy => {
                            const synergyNameForIcon = synergy.trim().replace(/\s+/g, '_');
                            memberCardHtml += `<span class="icon-wrapper"><img src="img/factions/${synergyNameForIcon}.png" alt="${synergy}" title="${synergy}" class="result-icon w-5 h-5" onerror="this.style.display='none'; const fb = this.parentElement.querySelector('.icon-placeholder'); if (fb) fb.style.display='inline-block';">`;
                            memberCardHtml += `<span class="icon-placeholder text-xs" style="display:none;">[${synergy}]</span></span>`;
                        });
                        memberCardHtml += `</div></div>`;
                    }
                    memberCardHtml += `</div>`;
                    membersGridDiv.innerHTML += memberCardHtml;
                });
            }
            teamContainerDiv.appendChild(membersGridDiv);
            savedTeamsListEl.appendChild(teamContainerDiv);

            // Add to exclusion dropdown
            const option = document.createElement('option');
            option.value = team.id;
            option.textContent = team.name;
            selectExclusionTeamDropdownEl.appendChild(option);
        });
    }
    
    excludeSavedTeamCheckboxEl.addEventListener('change', () => {
        selectExclusionTeamDropdownEl.disabled = !excludeSavedTeamCheckboxEl.checked;
        if (!excludeSavedTeamCheckboxEl.checked) {
            selectExclusionTeamDropdownEl.value = ""; 
        }
    });
    
    window.renameSavedTeam = async (teamId, currentName) => {
        if (!userId) {
             showToast("You must be signed in to rename teams.", "error");
            return;
        }
        openTeamNameModal(currentName, 'Rename Team', async (newName) => {
            if (newName && newName.trim() !== "" && newName.trim() !== currentName) {
                try {
                    const teamDocRef = doc(db, `artifacts/${appId}/users/${userId}/savedTeams`, teamId);
                    await updateDoc(teamDocRef, { name: newName.trim() });
                    showToast("Team renamed successfully.", "success");
                    loadSavedTeams(); 
                } catch (error) {
                    console.error("Error renaming saved team:", error);
                    showToast("Failed to rename team. Error: " + error.message, "error");
                }
            } else if (newName === "") {
                showToast("Team name cannot be empty.", "warning");
            } else {
                showToast("Rename cancelled or name unchanged.", "info");
            }
        });
    };


    window.deleteSavedTeam = async (teamId) => {
        if (!userId) {
            showToast("You must be signed in to delete teams.", "error");
            return;
        }
        if (!confirm("Are you sure you want to delete this saved team?")) return;

        try {
            const teamDocRef = doc(db, `artifacts/${appId}/users/${userId}/savedTeams`, teamId);
            await deleteDoc(teamDocRef);
            showToast("Team deleted successfully.", "info");
            loadSavedTeams(); 
        } catch (error) {
            console.error("Error deleting saved team:", error);
            showToast("Failed to delete team. Error: " + error.message, "error");
        }
    };

    // --- Synergy Modal Logic ---
    if (synergiesListEl) {
        synergiesListEl.addEventListener('click', (event) => {
            const synergyItem = event.target.closest('.synergy-item');
            if (synergyItem && synergyItem.dataset.synergyName) {
                const synergyName = synergyItem.dataset.synergyName;
                const matchingChampions = playerChampionRoster.filter(champ => 
                    (champ.inherentSynergies || []).includes(synergyName)
                );

                synergyModalTitleEl.textContent = `Champions with ${synergyName}`;
                if (matchingChampions.length > 0) {
                    synergyModalBodyEl.innerHTML = '<ul class="list-disc list-inside"></ul>';
                    const ul = synergyModalBodyEl.querySelector('ul');
                    matchingChampions.forEach(champ => {
                        const li = document.createElement('li');
                        li.textContent = champ.name;
                        ul.appendChild(li);
                    });
                } else {
                    synergyModalBodyEl.innerHTML = '<p>No champions in your roster have this synergy.</p>';
                }
                synergyChampionsModalEl.classList.remove('hidden');
                synergyChampionsModalEl.classList.add('active');
            }
        });
    }

    if (closeSynergyModalBtn) {
        closeSynergyModalBtn.addEventListener('click', () => {
            synergyChampionsModalEl.classList.add('hidden');
            synergyChampionsModalEl.classList.remove('active');
        });
    }
    if (synergyChampionsModalEl) {
        synergyChampionsModalEl.addEventListener('click', (event) => {
            if (event.target === synergyChampionsModalEl) {
                synergyChampionsModalEl.classList.add('hidden');
                synergyChampionsModalEl.classList.remove('active');
            }
        });
    }

    // --- "What If" Team Swap Logic ---
    window.handleOpenSwapModal = (indexToReplace) => {
        championToReplaceIndex = indexToReplace;
        if (!swapChampionModalEl.querySelector('.modal-content')) { // Build modal content if not already built
            swapChampionModalEl.innerHTML = `
                <div class="modal-content">
                    <div class="flex justify-between items-center mb-4">
                        <h3 id="swap-modal-title" class="text-xl font-semibold">Swap Champion</h3>
                        <button id="close-swap-modal-btn" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                    </div>
                    <div id="swap-modal-body" class="text-sm max-h-96 overflow-y-auto">
                        </div>
                </div>
            `;
            swapChampionModalEl.querySelector('#close-swap-modal-btn').addEventListener('click', () => {
                swapChampionModalEl.classList.add('hidden');
                swapChampionModalEl.classList.remove('active');
            });
            swapChampionModalEl.addEventListener('click', (event) => { // Backdrop click
                if (event.target === swapChampionModalEl) {
                    swapChampionModalEl.classList.add('hidden');
                    swapChampionModalEl.classList.remove('active');
                }
            });
        }

        const swapModalBody = swapChampionModalEl.querySelector('#swap-modal-body');
        swapModalBody.innerHTML = ''; // Clear previous list

        const currentTeamMemberIds = currentDisplayedTeam.members.map(m => m.dbChampionId);
        const availableToSwap = playerChampionRoster.filter(pChamp => !currentTeamMemberIds.includes(pChamp.dbChampionId));

        if (availableToSwap.length === 0) {
            swapModalBody.innerHTML = '<p>No other champions available in your roster to swap.</p>';
        } else {
            const ul = document.createElement('ul');
            ul.className = 'list-none space-y-2';
            availableToSwap.forEach(champ => {
                const li = document.createElement('li');
                li.className = 'p-3 border rounded-md hover:bg-gray-100 cursor-pointer flex justify-between items-center';
                li.dataset.champId = champ.id; 

                let champInfoHtml = `<div class="champion-details">
                                        <strong class="text-slate-700">${champ.name}</strong> 
                                        <span class="text-xs text-slate-500">(${champ.class || 'N/A'})</span>
                                        ${getStarRatingHTML(champ.starColorTier)}
                                     </div>`;
                
                if (champ.inherentSynergies && champ.inherentSynergies.length > 0) {
                    champInfoHtml += `<div class="champion-synergies flex gap-1 ml-auto">`; // Use ml-auto to push to right
                    champ.inherentSynergies.forEach(synergy => {
                        const synergyNameForIcon = synergy.trim().replace(/\s+/g, '_');
                        champInfoHtml += `<span class="icon-wrapper"><img src="img/factions/${synergyNameForIcon}.png" alt="${synergy}" title="${synergy}" class="result-icon w-4 h-4" onerror="this.style.display='none'; const fb = this.parentElement.querySelector('.icon-placeholder'); if (fb) fb.style.display='inline-block';"><span class="icon-placeholder text-xs" style="display:none;">[${synergy}]</span></span>`;
                    });
                    champInfoHtml += `</div>`;
                }
                
                li.innerHTML = champInfoHtml;

                li.addEventListener('click', () => {
                    handleChampionSwap(champ.id, championToReplaceIndex);
                    swapChampionModalEl.classList.add('hidden');
                    swapChampionModalEl.classList.remove('active');
                });
                ul.appendChild(li);
            });
            swapModalBody.appendChild(ul);
        }
        swapChampionModalEl.classList.remove('hidden');
        swapChampionModalEl.classList.add('active');
    }

    window.handleChampionSwap = async (selectedRosterChampId, indexToReplace) => {
        const newChampion = playerChampionRoster.find(rc => rc.id === selectedRosterChampId);
        if (!newChampion || indexToReplace < 0 || indexToReplace >= currentDisplayedTeam.members.length) {
            showToast("Error selecting champion for swap.", "error");
            return;
        }

        const newTeamMembers = [...currentDisplayedTeam.members];
        newTeamMembers[indexToReplace] = { 
            ...newChampion,
            individualScore: calculateIndividualChampionScore(newChampion) 
        };
        
        openProcessingModal();
        updateProcessingStatus("Recalculating team score...", 10);

        setTimeout(async () => {
            const recalculatedTeam = recalculateTeamScore(newTeamMembers);
            currentDisplayedTeam = recalculatedTeam; 
            currentBestTeamForSaving = JSON.parse(JSON.stringify(recalculatedTeam)); 
            
            updateProcessingStatus("Updating display...", 90);
            renderTeamDisplay(currentDisplayedTeam, true); 
            
            updateProcessingStatus("Recalculation complete!", 100);
            setTimeout(closeProcessingModal, 500);
        }, 50); 
    }
    
    window.handleResetTeam = () => {
        if (originalBestTeam) {
            currentDisplayedTeam = JSON.parse(JSON.stringify(originalBestTeam));
            currentBestTeamForSaving = JSON.parse(JSON.stringify(originalBestTeam));
            renderTeamDisplay(currentDisplayedTeam, true);
            showToast("Team reset to original calculation.", "info");
        }
    }

    function recalculateTeamScore(teamMembersArray) {
        const currentTeamBaseScoreSum = teamMembersArray.reduce((sum, member) => sum + (member.individualScore || calculateIndividualChampionScore(member)), 0);
        let scoreAfterPercentageSynergies = currentTeamBaseScoreSum;
        let totalPercentageBonusAppliedValue = 0;
        let accumulatedBaseFlatBonus = 0;
        let accumulatedTieredFlatBonus = 0;
        const activeSynergiesForTeamCalculation = [];

        const sortedSynergyDefs = [...dbSynergies].sort((a, b) => {
            if (a.bonusType === 'percentage' && b.bonusType !== 'percentage') return -1;
            if (a.bonusType !== 'percentage' && b.bonusType === 'percentage') return 1;
            return 0;
        });

        sortedSynergyDefs.forEach(synergyDef => {
            const membersWithSynergy = teamMembersArray.filter(member => (member.inherentSynergies || []).includes(synergyDef.name));
            const memberCount = membersWithSynergy.length;

            if (memberCount >= SYNERGY_ACTIVATION_COUNT) {
                let primaryBonusAppliedThisSynergy = 0;
                let tieredFlatBonusAppliedThisSynergy = 0;

                if (synergyDef.bonusValue !== undefined && synergyDef.bonusValue !== null) {
                    if (synergyDef.bonusType === 'percentage') {
                        const bonusValue = scoreAfterPercentageSynergies * (synergyDef.bonusValue / 100);
                        totalPercentageBonusAppliedValue += bonusValue;
                        scoreAfterPercentageSynergies += bonusValue;
                        primaryBonusAppliedThisSynergy = synergyDef.bonusValue;
                    } else if (synergyDef.bonusType === 'flat') {
                        accumulatedBaseFlatBonus += synergyDef.bonusValue;
                        primaryBonusAppliedThisSynergy = synergyDef.bonusValue;
                    }
                }
                if (memberCount === 3) tieredFlatBonusAppliedThisSynergy = 25000;
                else if (memberCount === 4) tieredFlatBonusAppliedThisSynergy = 100000;
                else if (memberCount >= 5) tieredFlatBonusAppliedThisSynergy = 250000;
                accumulatedTieredFlatBonus += tieredFlatBonusAppliedThisSynergy;
                
                activeSynergiesForTeamCalculation.push({
                    name: synergyDef.name, bonusType: synergyDef.bonusType,
                    primaryBonusApplied: primaryBonusAppliedThisSynergy,
                    tieredFlatBonusApplied: tieredFlatBonusAppliedThisSynergy,
                    description: synergyDef.description || '',
                    appliedAtMemberCount: memberCount
                });
            }
        });

        const totalFlatSynergyBonusComponent = accumulatedBaseFlatBonus + accumulatedTieredFlatBonus;
        const subtotalAfterSynergies = scoreAfterPercentageSynergies + totalFlatSynergyBonusComponent;
        
        const uniqueClassesInTeam = new Set(teamMembersArray.map(m => m.class).filter(c => c && c !== "N/A"));
        let classDiversityBonusValue = 0;
        let finalTeamScore = subtotalAfterSynergies;
        let classDiversityBonusApplied = false;

        if (uniqueClassesInTeam.size >= 4) {
            classDiversityBonusValue = subtotalAfterSynergies * (CLASS_DIVERSITY_MULTIPLIER - 1);
            finalTeamScore += classDiversityBonusValue;
            classDiversityBonusApplied = true;
        }

        return {
            members: teamMembersArray,
            totalScore: finalTeamScore,
            activeSynergies: activeSynergiesForTeamCalculation,
            baseScoreSum: currentTeamBaseScoreSum,
            uniqueClassesCount: uniqueClassesInTeam.size,
            classDiversityBonusApplied: classDiversityBonusApplied,
            scoreBreakdown: {
                base: currentTeamBaseScoreSum,
                percentageSynergyBonus: totalPercentageBonusAppliedValue,
                flatSynergyBonus: totalFlatSynergyBonusComponent,
                subtotalAfterSynergies: subtotalAfterSynergies,
                classDiversityBonus: classDiversityBonusValue,
            }
        };
    }


    // --- Initial Page Load ---
    async function main() {
        try {
            await initializeFirebase(); 
            
            // Set up button icons
            document.getElementById('add-update-champion-btn').innerHTML = `<span class="btn-icon">${ICON_ADD}</span> <span class="btn-text">Add Champion to Roster</span> <span id="save-roster-indicator" class="saving-indicator hidden"></span>`;
            document.getElementById('cancel-edit-btn').innerHTML = `<span class="btn-icon">${ICON_CANCEL}</span> <span class="btn-text">Cancel Edit</span>`;
            document.getElementById('calculate-btn').innerHTML = `<span class="btn-icon">${ICON_CALCULATE}</span> <span class="btn-text">Calculate Best Team</span>`;
            document.getElementById('save-team-name-btn').innerHTML = `<span class="btn-icon">${ICON_SAVE}</span> <span class="btn-text">Save Name</span>`;
            document.getElementById('cancel-team-name-btn').innerHTML = `<span class="btn-icon">${ICON_CANCEL}</span> <span class="btn-text">Cancel</span>`;


            populateStarColorOptions();
            populateGearRarityOptions(); 
            
            await Promise.all([
                fetchSynergiesAndRender(), 
                fetchChampions(),
                fetchLegacyPieces() 
            ]);
            
            await loadPlayerRosterFromFirestore(); 
            await loadSavedTeams(); 

            populateChampionSelect(); 
            
            synergiesSectionEl.classList.remove('hidden'); 
            loadingIndicatorEl.classList.add('hidden'); 

        } catch (error) {
            console.error("Main execution error:", error);
            loadingIndicatorEl.classList.add('hidden'); 
            if (!errorIndicatorEl.classList.contains('hidden')) { 
            } else { 
                 showError("An unexpected error occurred during page load.", error.message);
            }
        }
    }

    document.addEventListener('DOMContentLoaded', main);

</script>
</body>
</html>
ï¿½
